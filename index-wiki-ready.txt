{{html}}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>T1 → Mini-Rack MMC Mapper</title>
  <style>
    :root { --gap: 12px; --radius: 12px; --shadow: 0 10px 25px rgba(0,0,0,.08); }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background: #f7f7fb; color: #0b1220; }
    .app { max-width: 960px; margin: 0 auto; position: relative; z-index: 1; }
    .card { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; }
    h1 { margin: 0 0 6px; font-size: 22px; }
    /* Main heading with animation */
    .mainHeading { text-align: center; font-size: 42px; font-weight: 900; margin: 0 0 24px; padding: 24px 0; letter-spacing: -1px; color: #0b1220; animation: fadeInScale 0.8s ease-out, gradientShift 4s ease-in-out infinite; position: relative; text-shadow: 0 2px 8px rgba(59,130,246,0.2); }
    .mainHeading::after { content: ''; position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); width: 80px; height: 4px; background: linear-gradient(90deg, transparent, #3b82f6, transparent); border-radius: 2px; animation: shimmer 2s ease-in-out infinite; }
    @keyframes fadeInScale { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes gradientShift { 0%, 100% { text-shadow: 0 2px 8px rgba(59,130,246,0.2), 0 0 20px rgba(59,130,246,0.1); } 50% { text-shadow: 0 2px 12px rgba(59,130,246,0.4), 0 0 30px rgba(59,130,246,0.2); } }
    @keyframes shimmer { 0%, 100% { opacity: 0.3; width: 80px; } 50% { opacity: 1; width: 120px; } }
    html[data-theme="dark"] .mainHeading { color: #e5e7eb; text-shadow: 0 2px 8px rgba(96,165,250,0.3); animation: fadeInScale 0.8s ease-out, gradientShiftDark 4s ease-in-out infinite; }
    html[data-theme="dark"] .mainHeading::after { background: linear-gradient(90deg, transparent, #60a5fa, transparent); }
    @keyframes gradientShiftDark { 0%, 100% { text-shadow: 0 2px 8px rgba(96,165,250,0.3), 0 0 20px rgba(96,165,250,0.15); } 50% { text-shadow: 0 2px 12px rgba(96,165,250,0.5), 0 0 30px rgba(96,165,250,0.3); } }
    p.sub { margin: 0 0 16px; color: #374151; text-align: center; font-weight: 500; }
    html[data-theme="dark"] p.sub { color: #d1d5db; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: var(--gap); }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-weight: 600; font-size: 14px; color: #222; }
    input[type="text"], input[type="number"] { padding: 10px 12px; border: 1px solid #d9dbe7; border-radius: 8px; font-size: 14px; }
    input:focus { outline: none; border-color: #6a8dff; box-shadow: 0 0 0 3px rgba(106,141,255,.2); }
    .actions { display: flex; gap: var(--gap); margin-top: 16px; flex-wrap: wrap; }
    /* Default: light buttons so nothing looks active on load */
    button { 
      padding: 10px 14px; 
      border-radius: 10px; 
      border: 1px solid rgba(255,255,255,.2); 
      background: #eef0f8; 
      color: #0f172a; 
      font-weight: 700; 
      cursor: pointer; 
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(0px);
      -webkit-backdrop-filter: blur(0px);
    }
    /* Apple-style glass morphism on hover */
    button:hover { 
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-color: rgba(255,255,255,.4);
      box-shadow: 0 8px 32px rgba(0,0,0,.12), 
                  inset 0 1px 0 rgba(255,255,255,.6),
                  0 1px 2px rgba(0,0,0,.05);
      transform: translateY(-1px);
    }
    button:focus-visible { 
      outline: none; 
      box-shadow: 0 0 0 3px rgba(106,141,255,.35), 
                  0 8px 32px rgba(0,0,0,.12),
                  inset 0 1px 0 rgba(255,255,255,.6);
    }
    button:active { 
      transform: translateY(0px) scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,.1),
                  inset 0 1px 0 rgba(255,255,255,.4);
    }
    /* Keep .secondary same as default for simplicity */
    button.secondary { 
      background: #eef0f8; 
      color: #0f172a;
      border: 1px solid rgba(255,255,255,.2);
    }
    button.secondary:hover { 
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-color: rgba(255,255,255,.4);
      box-shadow: 0 8px 32px rgba(0,0,0,.12), 
                  inset 0 1px 0 rgba(255,255,255,.6),
                  0 1px 2px rgba(0,0,0,.05);
      transform: translateY(-1px);
    }
    button.secondary:focus-visible { 
      box-shadow: 0 0 0 3px rgba(106,141,255,.35), 
                  0 8px 32px rgba(0,0,0,.12),
                  inset 0 1px 0 rgba(255,255,255,.6);
    }
    /* Persistent active highlight applied via JS to the last clicked button */
    button.activeBtn { 
      background: #0f172a !important; 
      color: #fff !important; 
      box-shadow: 0 8px 18px rgba(0,0,0,.14) !important;
      border-color: rgba(255,255,255,.2) !important;
    }
    button.activeBtn:hover {
      background: rgba(15,23,42,.95) !important;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      transform: translateY(-1px);
    }
    html[data-theme="dark"] button.activeBtn {
      background: #1e293b !important;
      border-color: rgba(255,255,255,.15) !important;
    }
    html[data-theme="dark"] button.activeBtn:hover {
      background: rgba(30,41,59,.9) !important;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
    }
    .result { margin-top: 16px; padding: 14px; border-radius: 10px; background: #0f172a; color: #e5e7eb; }
    .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--gap); margin-top: 10px; }
    .kv { padding: 10px 12px; background: #111827; border-radius: 8px; }
    .kv b { display: block; font-size: 12px; color: #a5b4fc; font-weight: 700; margin-bottom: 4px; }
    .kv span { font-size: 16px; font-weight: 800; }
    /* Emphasis states for MMC and Spares */
    .kv.highlight-primary { box-shadow: 0 0 0 3px rgba(245,158,11,.55); background: #0f172a; }
    .kv.highlight-secondary { box-shadow: 0 0 0 3px rgba(34,197,94,.45); background: #0f172a; }
    .muted { color: #4b5563; font-size: 12px; margin-top: 8px; font-weight: 500; }
    html[data-theme="dark"] .muted { color: #d1d5db; }
    .err { margin-top: 10px; padding: 10px; border-radius: 8px; background: #fff3f3; color: #b00020; border: 1px solid #ffd5d5; }
    .fErr { color: #b00020; font-size: 12px; min-height: 14px; }
    button:disabled { opacity: .55; cursor: not-allowed; box-shadow: none; }
    .footer { margin-top: 18px; font-size: 12px; color: #5b6478; }
    code { background: #eff6ff; color: #1e40af; padding: 3px 8px; border-radius: 6px; border: 1px solid #dbeafe; font-weight: 600; font-size: 13px; }
    html[data-theme="dark"] code { background: rgba(59,130,246,.15); color: #93c5fd; border-color: rgba(59,130,246,.3); }
    .linkbtn { background: transparent; border: 0; color: #3b82f6; padding: 0; font-weight: 600; cursor: pointer; }
    .linkbtn:hover { text-decoration: underline; }
    /* T2 emphasis */
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 0 0 rgba(99,102,241,.35); }
      70% { box-shadow: 0 0 0 10px rgba(99,102,241,0); }
      100% { box-shadow: 0 0 0 0 rgba(99,102,241,0); }
    }
    .t2Hero { background: #0f172a; color: #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: var(--shadow); }
    .t2Hero .title { font-size: 12px; color: #0b1220; font-weight: 700; margin-bottom: 6px; }
    html[data-theme="dark"] .t2Hero .title { color: #a5b4fc; }
    /* T2 title visibility in glass morphism */
    .glassMorphism .t2Hero .title { color: #0b1220; font-weight: 700; }
    html[data-theme="dark"] .glassMorphism .t2Hero .title { color: #93c5fd; font-weight: 700; }
    .t2Hero .value { font-size: 22px; font-weight: 900; }
    .t2Hero .sub { font-size: 12px; color: #4b5563; margin-top: 6px; font-weight: 500; }
    html[data-theme="dark"] .t2Hero .sub { color: #d1d5db; }
    .t2Emph { border-radius: 10px; padding: 10px 12px; background: #111827; animation: pulseGlow 1.8s ease-in-out infinite; }
    /* History list */
    .history { display: flex; flex-direction: column; gap: 8px; }
    .histItem { display: flex; align-items: center; justify-content: space-between; border: 1px solid #e6e8f0; border-radius: 10px; padding: 8px 10px; background: #fff; }
    .histItem .meta { font-size: 12px; color: #6b7280; }
    .histItem .main { font-weight: 700; }
    .histActions { display: flex; gap: 8px; }
    /* Print styles */
    @media print {
      body { background: #fff; padding: 0; color: #000; }
      .actions, #autoExample, #toggleReverse, .linkbtn, #copy, #copyT2, #reset, #findMMC, #resetMMC, .footer { display: none !important; }
      .card { box-shadow: none; border: 1px solid #ddd; }
      .result, .t2Hero { background: #fff; color: #000; box-shadow: none; }
      .kv { background: #f9fafb; }
      .kv b { color: #111; }
      .kv span { color: #000; }
    }
    /* MMC mini-diagram */
    .diagram { margin-top: 12px; }
    .slots { display: grid; grid-template-columns: repeat(9, 1fr); gap: 6px; }
    .slot { padding: 6px 0; text-align: center; font-size: 12px; border-radius: 6px; border: 1px solid #e6e8f0; background: #fff; color: #111827; }
    .slot.spare { background: #ffffff; color: #111827; border-color: #10b981; box-shadow: 0 0 0 3px rgba(34,197,94,.45); }
    .slot.mmc { background: #eef2ff; border-color: #c7d2fe; }
    .slot.active { background: #ffffff; color: #111827; border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245,158,11,.55); font-weight: 900; }
    .diagram .legend { margin-top: 8px; font-size: 12px; color: #6b7280; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .legend .key { display: inline-flex; align-items: center; gap: 6px; }
    .legend .swatch { width: 14px; height: 14px; border-radius: 4px; display: inline-block; border: 1px solid #e6e8f0; }
    .legend .swatch.mmc { background: #eef2ff; border-color: #c7d2fe; }
    .legend .swatch.spare { background: #10b981; border-color: #059669; }
    .legend .swatch.active { background: #f59e0b; border-color: #d97706; }
    /* Floating theme switch (darkmode-switch style) */
    #theme-switch { height: 48px; width: 48px; padding: 0; border-radius: 50%; background: #eef0f8; display: flex; justify-content: center; align-items: center; position: fixed; top: 18px; right: 18px; border: 1px solid #e6e8f0; z-index: 3; }
    #theme-switch svg { fill: #3a435d; }
    #theme-switch svg:last-child { display: none; }
    html[data-theme="dark"] #theme-switch { background: #1f2937; border-color: #14213b; }
    html[data-theme="dark"] #theme-switch svg { fill: #93a2c9; }
    html[data-theme="dark"] #theme-switch svg:first-child { display: none; }
    html[data-theme="dark"] #theme-switch svg:last-child { display: block; }
    /* Animated background (subtle) */
    .bgAnim { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .bgAnim .blob { position: absolute; width: 52vw; height: 52vw; border-radius: 50%; filter: blur(68px); opacity: .12; transform: translate3d(0,0,0); mix-blend-mode: screen; }
    .bgAnim .b1 { top: -12vw; left: -12vw; background: radial-gradient(closest-side, #6366f1, rgba(99,102,241,0)); animation: blobX 28s ease-in-out infinite alternate, blobY 34s ease-in-out infinite alternate; }
    .bgAnim .b2 { bottom: -16vw; right: -10vw; background: radial-gradient(closest-side, #10b981, rgba(16,185,129,0)); animation: blobX 32s ease-in-out infinite alternate-reverse, blobY 26s ease-in-out infinite alternate; }
    .bgAnim .b3 { top: 20vh; right: 35vw; background: radial-gradient(closest-side, #60a5fa, rgba(96,165,250,0)); animation: blobX 38s ease-in-out infinite alternate, blobY 42s ease-in-out infinite alternate-reverse; width: 40vw; height: 40vw; }
    @keyframes blobX { from { transform: translateX(-2%); } to { transform: translateX(2%); } }
    @keyframes blobY { from { transform: translateY(-2%); } to { transform: translateY(2%); } }
    /* Sub text styling */
    .sub { color: #374151; font-weight: 500; }
    /* Dark mode overrides */
    html[data-theme="dark"] body { background: #0a0f1a; color: #e5e7eb; }
    html[data-theme="dark"] .card { background: #0f172a; box-shadow: none; border: 1px solid #14213b; }
    html[data-theme="dark"] .sub { color: #d1d5db; }
    html[data-theme="dark"] .actions button { 
      background: #1f2937; 
      color: #e5e7eb;
      border-color: rgba(255,255,255,.1);
    }
    /* Dark mode glass morphism - Apple style */
    html[data-theme="dark"] button:hover { 
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-color: rgba(255,255,255,.15);
      box-shadow: 0 8px 32px rgba(0,0,0,.4), 
                  inset 0 1px 0 rgba(255,255,255,.1),
                  0 1px 2px rgba(0,0,0,.2);
      transform: translateY(-1px);
    }
    html[data-theme="dark"] button.secondary { 
      background: #1f2937; 
      color: #e5e7eb;
      border-color: rgba(255,255,255,.1);
    }
    html[data-theme="dark"] button.secondary:hover {
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-color: rgba(255,255,255,.15);
      box-shadow: 0 8px 32px rgba(0,0,0,.4), 
                  inset 0 1px 0 rgba(255,255,255,.1),
                  0 1px 2px rgba(0,0,0,.2);
      transform: translateY(-1px);
    }
    html[data-theme="dark"] button:focus-visible {
      box-shadow: 0 0 0 3px rgba(106,141,255,.35), 
                  0 8px 32px rgba(0,0,0,.4),
                  inset 0 1px 0 rgba(255,255,255,.1);
    }
    html[data-theme="dark"] button:active {
      box-shadow: 0 2px 8px rgba(0,0,0,.3),
                  inset 0 1px 0 rgba(255,255,255,.05);
    }
    html[data-theme="dark"] .result { background: #0b1220; color: #e5e7eb; }
    html[data-theme="dark"] .kv { background: #0b1220; border: 1px solid #1f2937; }
    html[data-theme="dark"] .kv b { color: #93c5fd; }
    html[data-theme="dark"] .kv span { color: #e5e7eb; }
    html[data-theme="dark"] .err { background: #2b1a1a; color: #fecaca; border-color: #7f1d1d; }
    html[data-theme="dark"] input[type="text"],
    html[data-theme="dark"] input[type="number"] { background: #0b1220; color: #e5e7eb; border-color: #253141; }
    html[data-theme="dark"] input::placeholder { color: #6b7280; }
    html[data-theme="dark"] .diagram .legend { color: #9aa6c1; }
    html[data-theme="dark"] .slot { background: #0f172a; color: #e5e7eb; border-color: #253141; }
    html[data-theme="dark"] .slot.mmc { background: #1e293b; border-color: #334155; }
    html[data-theme="dark"] .slot.active { background: #0f172a; color: #fff; border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245,158,11,.45); }
    html[data-theme="dark"] .slot.spare { background: #0f172a; color: #e5e7eb; border-color: #10b981; box-shadow: 0 0 0 3px rgba(34,197,94,.35); }
    html[data-theme="dark"] .legend .swatch.mmc { background: #1e293b; border-color: #334155; }
    html[data-theme="dark"] .legend .swatch.spare { background: #065f46; border-color: #059669; }
    html[data-theme="dark"] .legend .swatch.active { background: #f59e0b; border-color: #b45309; }
    /* Explicit light theme tweaks (white background preference) */
    html[data-theme="light"] body { background: #ffffff; color: #0b1220; }
    html[data-theme="light"] .bgAnim .blob { opacity: .06; filter: blur(60px); }
    /* Dark mode tuning for background */
    html[data-theme="dark"] .bgAnim .blob { opacity: .18; filter: blur(78px); }
    html[data-theme="dark"] .bgAnim .b1 { background: radial-gradient(closest-side, #4f46e5, rgba(79,70,229,0)); }
    html[data-theme="dark"] .bgAnim .b2 { background: radial-gradient(closest-side, #059669, rgba(5,150,105,0)); }
    html[data-theme="dark"] .bgAnim .b3 { background: radial-gradient(closest-side, #3b82f6, rgba(59,130,246,0)); }
    /* Dark mode form and history readability fixes */
    html[data-theme="dark"] label { color: #e5e7eb; }
    html[data-theme="dark"] .fErr { color: #fecaca; }
    html[data-theme="dark"] .linkbtn { color: #60a5fa; }
    html[data-theme="dark"] .history .histItem { background: #0f172a; border-color: #14213b; }
    html[data-theme="dark"] .histItem .main { color: #e5e7eb; }
    html[data-theme="dark"] .histItem .meta { color: #9aa6c1; }
    /* NDF hero styles */
    .ndfHero { background: #0f172a; color: #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
    @keyframes glowSweep { 0% { box-shadow: 0 0 0 0 rgba(59,130,246,.0);} 50% { box-shadow: 0 0 0 8px rgba(59,130,246,.15);} 100% { box-shadow: 0 0 0 0 rgba(59,130,246,.0);} }
    .ndfEmph { border-radius: 10px; padding: 10px 12px; background: #0b1220; box-shadow: 0 0 0 3px rgba(59,130,246,.35); }
    .ndfHero.show { animation: glowSweep 1.2s ease-in-out 1; }
    .ndfTitle { font-size: 12px; color: #93c5fd; font-weight: 700; margin-bottom: 6px; }
    .ndfVal { font-size: 20px; font-weight: 900; }
    .flowBar { display: flex; align-items: center; gap: 8px; color: #4b5563; margin: 10px 0; font-weight: 500; }
    .flowBar .sep { font-size: 16px; }
    html[data-theme="dark"] .flowBar { color: #d1d5db; }
    /* 4-Channel Summary Styles */
    #ndfChannelSummary { border-top-color: #e6e8f0; }
    html[data-theme="dark"] #ndfChannelSummary { border-top-color: #334155; }
    #ndfChannelSummary .ndfTitle { color: #6b7280; }
    html[data-theme="dark"] #ndfChannelSummary .ndfTitle { color: #9aa6c1; }
    #ndfSummaryList span { display: block; padding: 6px 10px; border-radius: 6px; font-size: 13px; }
    /* Cable Color Classes */
    /* Cable 01 - Dark Blue */
    .cable1 { background: rgba(30,58,138,.15); color: #1e3a8a; border: 1px solid rgba(30,58,138,.3); }
    html[data-theme="dark"] .cable1 { background: rgba(30,58,138,.25); color: #3b82f6; border-color: rgba(30,58,138,.5); }
    /* Cable 02 - Orange */
    .cable2 { background: rgba(234,88,12,.15); color: #ea580c; border: 1px solid rgba(234,88,12,.3); }
    html[data-theme="dark"] .cable2 { background: rgba(234,88,12,.25); color: #fdba74; border-color: rgba(234,88,12,.5); }
    /* Cable 03 - Green */
    .cable3 { background: rgba(34,197,94,.15); color: #22c55e; border: 1px solid rgba(34,197,94,.3); }
    html[data-theme="dark"] .cable3 { background: rgba(34,197,94,.25); color: #4ade80; border-color: rgba(34,197,94,.5); }
    /* Cable 04 - Dark Brown */
    .cable4 { background: rgba(120,53,15,.15); color: #78350f; border: 1px solid rgba(120,53,15,.3); }
    html[data-theme="dark"] .cable4 { background: rgba(120,53,15,.25); color: #d97706; border-color: rgba(120,53,15,.5); }
    /* Cable 05 - Light cement */
    .cable5 { background: rgba(156,163,175,.15); color: #9ca3af; border: 1px solid rgba(156,163,175,.3); }
    html[data-theme="dark"] .cable5 { background: rgba(156,163,175,.25); color: #d1d5db; border-color: rgba(156,163,175,.5); }
    /* Cable 06 - White */
    .cable6 { background: rgba(255,255,255,.2); color: #374151; border: 1px solid rgba(209,213,219,.4); }
    html[data-theme="dark"] .cable6 { background: rgba(249,250,251,.15); color: #f9fafb; border-color: rgba(209,213,219,.5); }
    /* Cable 07 - Red */
    .cable7 { background: rgba(220,38,38,.15); color: #dc2626; border: 1px solid rgba(220,38,38,.3); }
    html[data-theme="dark"] .cable7 { background: rgba(220,38,38,.25); color: #ef4444; border-color: rgba(220,38,38,.5); }
    /* Cable 08 - Black */
    .cable8 { background: rgba(0,0,0,.15); color: #1f2937; border: 1px solid rgba(0,0,0,.3); }
    html[data-theme="dark"] .cable8 { background: rgba(75,85,99,.25); color: #9ca3af; border-color: rgba(75,85,99,.5); }
    /* NDF MMC Cable Color */
    #ndfMMC.cable1 { color: #1e3a8a !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable1 { color: #3b82f6 !important; }
    #ndfMMC.cable2 { color: #ea580c !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable2 { color: #fdba74 !important; }
    #ndfMMC.cable3 { color: #22c55e !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable3 { color: #4ade80 !important; }
    #ndfMMC.cable4 { color: #78350f !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable4 { color: #d97706 !important; }
    #ndfMMC.cable5 { color: #9ca3af !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable5 { color: #d1d5db !important; }
    #ndfMMC.cable6 { color: #374151 !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable6 { color: #f9fafb !important; }
    #ndfMMC.cable7 { color: #dc2626 !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable7 { color: #ef4444 !important; }
    #ndfMMC.cable8 { color: #1f2937 !important; font-weight: 900; }
    html[data-theme="dark"] #ndfMMC.cable8 { color: #9ca3af !important; }
    /* T2 checkmark */
    @keyframes popIn { 0% { transform: scale(.6); opacity: 0; } 60% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    .tick { display: inline-block; margin-left: 8px; color: #22c55e; font-weight: 900; opacity: 0; transform: scale(.6); }
    .tick.show { opacity: 1; animation: popIn .35s ease-out forwards; }
    /* Subtle UI Animations */
    @keyframes gentleFadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
    @keyframes softSlideUp { 0% { opacity: 0; transform: translateY(8px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes loadingSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Smooth result appearance */
    .result { transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
    .result[style*="block"] { animation: gentleFadeIn 0.4s ease-out; }
    .ndfHero, .t2Hero { transition: opacity 0.3s ease-out; }
    .ndfHero[style*="block"], .t2Hero[style*="block"] { animation: softSlideUp 0.3s ease-out; }
    
    /* Glass morphism transition already in main button styles */
    
    /* Smooth scroll behavior */
    html { scroll-behavior: smooth; }
    
    /* Subtle copy success feedback */
    .copy-success { transition: all 0.2s ease; }
    button.copy-success { background: #22c55e !important; color: #fff !important; }
    html[data-theme="dark"] button.copy-success { background: #16a34a !important; }
    
    /* Data Flow Diagram Styles */
    .flowDiagram { margin-top: 20px; padding: 20px; background: rgba(255,255,255,.5); border-radius: 12px; border: 1px solid rgba(0,0,0,.1); overflow-x: auto; }
    html[data-theme="dark"] .flowDiagram { background: rgba(15,23,42,.5); border-color: rgba(255,255,255,.1); }
    .flowDiagram svg { width: 100%; min-width: 900px; height: auto; min-height: 550px; max-height: 650px; display: block; }
    @media (max-width: 1200px) {
      .flowDiagram svg { min-width: 100%; min-height: 500px; max-height: 600px; }
    }
    @media (max-width: 768px) {
      .flowDiagram svg { min-width: 100%; min-height: 450px; max-height: 550px; }
    }
    .flowPath { stroke-width: 3.5; fill: none; stroke-dasharray: 8 4; transition: stroke 0.3s ease; }
    /* Ensure paths never block clicks on rack boxes */
    .flowPath, .flowCable { pointer-events: none; }
    .flowNode { pointer-events: all; }
    .flowPath.active { stroke-dasharray: 8 4; animation: flowPath 2s linear infinite; }
    .flowPath.inactive { stroke: #9ca3af; opacity: 0.7; }
    html[data-theme="dark"] .flowPath.inactive { stroke: #94a3b8; opacity: 0.8; }
    /* Cable color classes for flow paths */
    .flowPath.cable1 { stroke: #1e3a8a !important; }
    html[data-theme="dark"] .flowPath.cable1 { stroke: #3b82f6 !important; }
    .flowPath.cable2 { stroke: #ea580c !important; }
    html[data-theme="dark"] .flowPath.cable2 { stroke: #fdba74 !important; }
    .flowPath.cable3 { stroke: #22c55e !important; }
    html[data-theme="dark"] .flowPath.cable3 { stroke: #4ade80 !important; }
    .flowPath.cable4 { stroke: #78350f !important; }
    html[data-theme="dark"] .flowPath.cable4 { stroke: #d97706 !important; }
    .flowPath.cable5 { stroke: #9ca3af !important; }
    html[data-theme="dark"] .flowPath.cable5 { stroke: #d1d5db !important; }
    .flowPath.cable6 { stroke: #ffffff !important; }
    html[data-theme="dark"] .flowPath.cable6 { stroke: #f9fafb !important; }
    .flowPath.cable7 { stroke: #dc2626 !important; }
    html[data-theme="dark"] .flowPath.cable7 { stroke: #ef4444 !important; }
    .flowPath.cable8 { stroke: #000000 !important; }
    html[data-theme="dark"] .flowPath.cable8 { stroke: #4b5563 !important; }
    @keyframes flowPath { 0% { stroke-dashoffset: 24; } 100% { stroke-dashoffset: 0; } }
    /* Color classes for text labels */
    .flowLabel.cable1 { fill: #1e3a8a !important; }
    html[data-theme="dark"] .flowLabel.cable1 { fill: #3b82f6 !important; }
    .flowLabel.cable2 { fill: #ea580c !important; }
    html[data-theme="dark"] .flowLabel.cable2 { fill: #fdba74 !important; }
    .flowLabel.cable3 { fill: #22c55e !important; }
    html[data-theme="dark"] .flowLabel.cable3 { fill: #4ade80 !important; }
    .flowLabel.cable4 { fill: #78350f !important; }
    html[data-theme="dark"] .flowLabel.cable4 { fill: #d97706 !important; }
    .flowLabel.cable5 { fill: #9ca3af !important; }
    html[data-theme="dark"] .flowLabel.cable5 { fill: #d1d5db !important; }
    .flowLabel.cable6 { fill: #374151 !important; }
    html[data-theme="dark"] .flowLabel.cable6 { fill: #f9fafb !important; }
    .flowLabel.cable7 { fill: #dc2626 !important; }
    html[data-theme="dark"] .flowLabel.cable7 { fill: #ef4444 !important; }
    .flowLabel.cable8 { fill: #1f2937 !important; }
    html[data-theme="dark"] .flowLabel.cable8 { fill: #9ca3af !important; }
    .flowNode { cursor: pointer; transition: all 0.3s ease; }
    .flowNode:hover { filter: brightness(1.1); }
    .flowLabel { font-size: 11px; fill: #6b7280; font-weight: 600; }
    html[data-theme="dark"] .flowLabel { fill: #9aa6c1; }
    .flowLabel.highlight { fill: #3b82f6; font-weight: 700; font-size: 12px; }
    html[data-theme="dark"] .flowLabel.highlight { fill: #60a5fa; }
    /* T2 box text colors - ensure white text is visible on dark background, dark text on light background */
    /* T2 info (larger text) */
    #t2Ch1Label, #t2Ch2Label, #t2Ch3Label, #t2Ch4Label, #t2Ch5Label, #t2Ch6Label, #t2Ch7Label, #t2Ch8Label,
    #t2Ch1Jrp, #t2Ch2Jrp, #t2Ch3Jrp, #t2Ch4Jrp, #t2Ch5Jrp, #t2Ch6Jrp, #t2Ch7Jrp, #t2Ch8Jrp {
      fill: white !important;
      font-size: 12px !important;
    }
    /* T1 info (smaller text) */
    #t2Ch1T1Info, #t2Ch2T1Info, #t2Ch3T1Info, #t2Ch4T1Info, #t2Ch5T1Info, #t2Ch6T1Info, #t2Ch7T1Info, #t2Ch8T1Info {
      fill: white !important;
      font-size: 9px !important;
      opacity: 0.8 !important;
    }
    html[data-theme="light"] #t2Ch1Label, html[data-theme="light"] #t2Ch2Label, html[data-theme="light"] #t2Ch3Label,
    html[data-theme="light"] #t2Ch4Label, html[data-theme="light"] #t2Ch5Label, html[data-theme="light"] #t2Ch6Label,
    html[data-theme="light"] #t2Ch7Label, html[data-theme="light"] #t2Ch8Label,
    html[data-theme="light"] #t2Ch1Jrp, html[data-theme="light"] #t2Ch2Jrp, html[data-theme="light"] #t2Ch3Jrp,
    html[data-theme="light"] #t2Ch4Jrp, html[data-theme="light"] #t2Ch5Jrp, html[data-theme="light"] #t2Ch6Jrp,
    html[data-theme="light"] #t2Ch7Jrp, html[data-theme="light"] #t2Ch8Jrp {
      fill: #1f2937 !important;
    }
    html[data-theme="light"] #t2Ch1T1Info, html[data-theme="light"] #t2Ch2T1Info, html[data-theme="light"] #t2Ch3T1Info,
    html[data-theme="light"] #t2Ch4T1Info, html[data-theme="light"] #t2Ch5T1Info, html[data-theme="light"] #t2Ch6T1Info,
    html[data-theme="light"] #t2Ch7T1Info, html[data-theme="light"] #t2Ch8T1Info {
      fill: #4b5563 !important;
    }
    .dataPacket { fill: #3b82f6; animation: flowAnimation 3s linear infinite; }
    html[data-theme="dark"] .dataPacket { fill: #60a5fa; }
    .dataPacket.active { animation-play-state: running; opacity: 1; }
    .dataPacket.inactive { animation-play-state: paused; opacity: 0.2; }
    @keyframes flowAnimation {
      0% { transform: translate(0, 0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translate(var(--flow-end-x, 100%), var(--flow-end-y, 0)); opacity: 0; }
    }
    .flowRack { fill: #1b1b2f; stroke: #475569; stroke-width: 2; transition: all 0.2s ease; }
    html[data-theme="dark"] .flowRack { fill: #1b1b2f; stroke: #475569; }
    html[data-theme="light"] .flowRack { fill: #f3f4f6; stroke: #9ca3af; }
    .flowRack.highlight { fill: #dbeafe; stroke: #3b82f6; stroke-width: 3; }
    html[data-theme="dark"] .flowRack.highlight { fill: #1e3a5f; stroke: #60a5fa; }
    /* Animation for requested T1 block */
    @keyframes pulseGlow {
      0%, 100% { 
        filter: brightness(1) drop-shadow(0 0 4px rgba(59, 130, 246, 0.6));
        stroke-width: 3;
      }
      50% { 
        filter: brightness(1.4) drop-shadow(0 0 12px rgba(59, 130, 246, 0.9));
        stroke-width: 3.5;
      }
    }
    @keyframes pulseGlowDark {
      0%, 100% { 
        filter: brightness(1) drop-shadow(0 0 4px rgba(96, 165, 250, 0.6));
        stroke-width: 3;
      }
      50% { 
        filter: brightness(1.4) drop-shadow(0 0 12px rgba(96, 165, 250, 0.9));
        stroke-width: 3.5;
      }
    }
    .flowRack.userRequested {
      animation: pulseGlow 2s ease-in-out infinite;
    }
    html[data-theme="dark"] .flowRack.userRequested {
      animation: pulseGlowDark 2s ease-in-out infinite;
    }
    /* Color coding for racks based on channel (cable colors) */
    /* T1 Rack and T2 Channel colors */
    .flowRack.cable1 { fill: rgba(30,58,138,.15); stroke: #1e3a8a; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable1 { fill: rgba(30,58,138,.25); stroke: #3b82f6; }
    .flowRack.cable2 { fill: rgba(234,88,12,.15); stroke: #ea580c; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable2 { fill: rgba(234,88,12,.25); stroke: #fdba74; }
    .flowRack.cable3 { fill: rgba(34,197,94,.15); stroke: #22c55e; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable3 { fill: rgba(34,197,94,.25); stroke: #4ade80; }
    .flowRack.cable4 { fill: rgba(120,53,15,.15); stroke: #78350f; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable4 { fill: rgba(120,53,15,.25); stroke: #d97706; }
    .flowRack.cable5 { fill: rgba(156,163,175,.15); stroke: #9ca3af; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable5 { fill: rgba(156,163,175,.25); stroke: #d1d5db; }
    .flowRack.cable6 { fill: rgba(255,255,255,.2); stroke: #ffffff; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable6 { fill: rgba(249,250,251,.15); stroke: #f9fafb; }
    .flowRack.cable7 { fill: rgba(220,38,38,.15); stroke: #dc2626; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable7 { fill: rgba(220,38,38,.25); stroke: #ef4444; }
    .flowRack.cable8 { fill: rgba(0,0,0,.15); stroke: #000000; stroke-width: 2.5; }
    html[data-theme="dark"] .flowRack.cable8 { fill: rgba(75,85,99,.25); stroke: #4b5563; }
    .flowRack.active { stroke-width: 4; box-shadow: 0 0 8px rgba(59,130,246,.4); }
    html[data-theme="dark"] .flowRack.active { box-shadow: 0 0 8px rgba(96,165,250,.4); }
    .flowCable { stroke: #fbbf24; stroke-width: 4; fill: none; }
    .flowCable.active { stroke: #f59e0b; animation: pulseCable 2s ease-in-out infinite; }
    @keyframes pulseCable { 0%, 100% { stroke-width: 4; opacity: 1; } 50% { stroke-width: 6; opacity: 0.8; } }
    .flowDiagramTitle { color: #6b7280; }
    html[data-theme="dark"] .flowDiagramTitle { color: #9aa6c1; }
    
    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .result, .ndfHero, .t2Hero, button { animation: none !important; transition: none !important; }
      .flowPath.active, .dataPacket.active, .flowCable.active { animation: none !important; }
      html { scroll-behavior: auto; }
    }
    @media (max-width: 900px) {
      .grid, .row { grid-template-columns: 1fr; }
    }
    /* Respect reduced motion and print */
    @media (prefers-reduced-motion: reduce) {
      .bgAnim .blob { animation: none; }
    }
    @media print {
      .bgAnim { display: none !important; }
    }
    /* Tab interface styles */
    .tabContainer { width: 100%; }
    .tabHeader { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e6e8f0; }
    .tabBtn { padding: 8px 20px; border: none; background: transparent; color: #6b7280; font-size: 16px; font-weight: 700; cursor: pointer; transition: all .2s ease; border-radius: 6px 6px 0 0; }
    .tabBtn:hover { color: #0b1220; background: rgba(106,141,255,.08); }
    .tabBtn.active { color: #0b1220; position: relative; }
    .tabBtn.ndf.active { background: rgba(16,185,129,.12); }
    .tabBtn.ndf.active::after { content: ''; position: absolute; bottom: -14px; left: 0; right: 0; height: 3px; background: #10b981; border-radius: 2px 2px 0 0; }
    .tabBtn.t2.active { background: rgba(59,130,246,.12); }
    .tabBtn.t2.active::after { content: ''; position: absolute; bottom: -14px; left: 0; right: 0; height: 3px; background: #3b82f6; border-radius: 2px 2px 0 0; }
    .tabSeparator { color: #d1d5db; font-weight: 400; user-select: none; }
    .tabContent { position: relative; min-height: 120px; }
    .tabPane { display: none; padding: 0; border-radius: 12px; transition: opacity .3s ease; }
    .tabPane.active { display: block; }
    /* Glass morphism effect */
    .glassMorphism { background: rgba(255,255,255,.65); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); border: 1px solid rgba(255,255,255,.4); box-shadow: 0 8px 32px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.6); border-radius: 12px; padding: 20px; }
    html[data-theme="dark"] .glassMorphism { background: rgba(15,23,42,.7); border-color: rgba(255,255,255,.12); box-shadow: 0 8px 32px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.1); }
    .glassMorphism .ndfHero, .glassMorphism .t2Hero { background: transparent; box-shadow: none; }
    html[data-theme="dark"] .tabHeader { border-bottom-color: #14213b; }
    html[data-theme="dark"] .tabBtn { color: #9aa6c1; }
    html[data-theme="dark"] .tabBtn:hover { color: #e5e7eb; background: rgba(99,102,241,.15); }
    html[data-theme="dark"] .tabBtn.active { color: #e5e7eb; }
    html[data-theme="dark"] .tabBtn.ndf.active { background: rgba(16,185,129,.22); }
    html[data-theme="dark"] .tabBtn.ndf.active::after { background: #10b981; }
    html[data-theme="dark"] .tabBtn.t2.active { background: rgba(59,130,246,.22); }
    html[data-theme="dark"] .tabBtn.t2.active::after { background: #60a5fa; }
    html[data-theme="dark"] .tabSeparator { color: #374151; }
  </style>
</head>
<body>
  <button id="theme-switch" aria-label="Toggle theme" title="Toggle theme">
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z"/></svg>
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Z"/></svg>
  </button>
  <div class="bgAnim" aria-hidden="true">
    <span class="blob b1"></span>
    <span class="blob b2"></span>
    <span class="blob b3"></span>
  </div>
  <div class="app">
    <div class="card">
      <h1 class="mainHeading">T1-T2 Mapper</h1>
      <p class="sub">Enter a T1 device (e.g., <code>sbn100-104-es-m1-p5-t1-r89</code>) and JRP/Port-Channel (e.g., <code>30-1</code> or just <code>30</code> for channel 1). The tool maps to the Mini‑Rack MMC and spares, computes T2 uplink details, and shows NDF RU (Rack Units: RU45, RU44, RU43, RU41, RU39, RU37, RU28, RU26, RU24, RU22, RU20, RU18, RU16) and active cable range for Racks 1–42, 51, 61–85, 86–96, 99–100, 101–102, 106–107, 111–112, and 114 of T1. Use Reverse Lookup for MMC → T1, and the mini‑diagram to jump between MMCs.</p>

      <div class="grid">
        <div class="field">
          <label for="dev">Device name</label>
          <input id="dev" type="text" placeholder="sbn100-104-es-m1-p5-t1-r89">
          <div class="fErr" id="errDev"></div>
          <div class="muted">Need a quick sample? <button type="button" id="autoExample" class="linkbtn">Example</button></div>
        </div>
        <div class="field">
          <label for="jrp">JRP / Port (17–32)</label>
          <input id="jrp" type="text" placeholder="30-1 (channel defaults to 1 if omitted)">
          <div class="fErr" id="errJrp"></div>
          <div class="muted">Format: JRP-Channel (e.g., 30-1 or just 30 for channel 1)</div>
        </div>
      </div>

      <div class="actions">
        <button id="calc">Find Connection</button>
        <button class="secondary" id="reset">Reset</button>
        <button class="secondary" id="copy">Copy Result</button>
        <button class="secondary" id="toggleReverse">Reverse Lookup (MMC → T1)</button>
      </div>

      <div id="error" class="err" style="display:none;"></div>

      <div id="out" class="result" style="display:none;">
        <div class="row">
          <div class="kv"><b>Device</b><span id="oDev"></span></div>
          <div class="kv"><b>Switch (p#)</b><span id="oSwitch"></span></div>
          <div class="kv"><b>Rack (r#)</b><span id="oRack"></span></div>
          <div class="kv"><b>JRP / Port</b><span id="oPort"></span></div>
        </div>
        <div class="row">
          <div class="kv"><b>Mini-Rack MMC</b><span id="oMMC"></span></div>
          <div class="kv"><b>Spare 1</b><span id="oSp1"></span></div>
          <div class="kv"><b>Spare 2</b><span id="oSp2"></span></div>
          <div class="kv"><b>Notes</b><span id="oNotes"></span></div>
        </div>
        <div class="muted" id="more" style="display:none;"></div>
        <div id="mmcViz" class="diagram" aria-hidden="false" style="display:block;">
          <div class="legend">
            <span class="key"><span class="swatch active"></span> Active MMC</span>
            <span class="key"><span class="swatch mmc"></span> MMCs (1–16)</span>
            <span class="key"><span class="swatch spare"></span> Spares (17–18)</span>
          </div>
          <div id="mmcDiagram" class="slots"></div>
        </div>
      </div>

      <div class="footer" id="logicPanel" style="display:none;">
        <div><b>Logic</b>:</div>
        <div>Let <code>P</code> be switch number parsed from <code>-p#-</code>, <code>j</code> be JRP (17..32).</div>
        <div>Pair index: <code>k = floor((P − 1) / 2)</code></div>
        <div>Block start: <code>block_start = 18×k + 1</code></div>
        <div>Offset: <code>0</code> if P odd, <code>8</code> if P even</div>
        <div>Pair index in switch: <code>i = floor((j − 17)/2)</code></div>
        <div>MMC: <code>MMC = block_start + offset + i</code></div>
        <div>Spares: <code>Spare1 = 18×k + 17</code>, <code>Spare2 = 18×k + 18</code></div>
        <div class="muted" id="logicComputed"></div>
      </div>

      <div id="reversePanel" class="card" style="margin-top:16px; display:none;">
        <h1>Mini-Rack MMC → T1 Switch Mapper</h1>
        <p class="sub">Enter an <b>MMC number (1–144)</b> to find the corresponding <b>T1 switch</b> and <b>JRP ports</b>.</p>

        <div class="grid">
          <div class="field">
            <label for="mmcInput">MMC Number</label>
            <input id="mmcInput" type="number" min="1" max="144" placeholder="e.g. 78">
          </div>
        </div>

        <div class="actions">
          <button id="findMMC">Find T1 Mapping</button>
          <button class="secondary" id="resetMMC">Reset</button>
        </div>

        <div id="errorMMC" class="err" style="display:none;"></div>

        <div id="outMMC" class="result" style="display:none;">
          <div class="row">
            <div class="kv"><b>MMC</b><span id="rMMC"></span></div>
            <div class="kv"><b>Switch (P#)</b><span id="rSwitch"></span></div>
            <div class="kv"><b>JRP Ports</b><span id="rPorts"></span></div>
          </div>
          <div class="muted" id="rMore"></div>
        </div>
      </div>
      
      <div id="ndfT2Panel" class="card" style="margin-top:16px;">
        <div class="tabContainer">
          <div class="tabHeader">
            <button class="tabBtn ndf active" id="tabNDF" data-tab="ndf">NDF</button>
            <span class="tabSeparator">|</span>
            <button class="tabBtn t2" id="tabT2" data-tab="t2">T2</button>
          </div>
          <div class="tabContent">
            <div id="ndfTab" class="tabPane active glassMorphism">
        <div class="flowBar"><span>T1</span><span class="sep">➜</span><span>Mini‑Rack</span><span class="sep">➜</span><span>NDF</span><span class="sep">➜</span><span>T2</span></div>
        <div id="outNDF" class="ndfHero" style="display:none;">
          <div class="ndfTitle" id="ndfTitle">NDF</div>
          <div class="row" style="margin-top:6px;">
            <div class="kv ndfEmph"><b>Rack Unit</b><span class="ndfVal" id="ndfRU"></span></div>
            <div class="kv ndfEmph"><b>MMC</b><span class="ndfVal" id="ndfMMC"></span></div>
            <div class="kv"><b>Cable</b><span class="ndfVal" id="ndfCable"></span></div>
            <div class="kv"><b>Active Range</b><span class="ndfVal" id="ndfRange"></span></div>
          </div>
          <div class="actions" style="margin-top:12px;">
            <button class="secondary" id="copyNDF">Copy NDF details</button>
          </div>
          <div class="sub" id="ndfNote"></div>
        </div>
              <div id="ndfChannelSummary" style="margin-top: 15px; border-top: 1px solid #e6e8f0; padding-top: 15px; display: none;">
                <div class="ndfTitle" style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">
                  4-Channel Port Connections (T2 JRP <span id="ndfT2JrpNum"></span>)
                </div>
                <div id="ndfSummaryList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                </div>
              </div>
              <div id="flowDiagramContainer" class="flowDiagram" style="display: none; margin-top: 20px;">
                <div class="flowDiagramTitle" style="font-size: 14px; font-weight: 700; color: #6b7280; margin-bottom: 12px;">Data Flow Path</div>
                <svg id="dataFlowDiagram" viewBox="0 0 950 760" xmlns="http://www.w3.org/2000/svg">
                  <!-- Associated T1 Racks (4 racks sharing same MMC) -->
                  <g id="associatedT1Racks">
                    <text x="50" y="30" text-anchor="middle" class="flowLabel" font-size="12" font-weight="700" fill="#9ca3af">Associated T1 Racks</text>
                    <g class="flowNode" id="t1Rack1">
                      <rect x="10" y="50" width="70" height="40" rx="4" class="flowRack"/>
                      <text x="45" y="65" text-anchor="middle" class="flowLabel" id="t1R1Label" font-size="9" font-weight="600">P-R · JRP</text>
                      <text x="45" y="80" text-anchor="middle" class="flowLabel" id="t1R1Jrp" font-size="8" fill="#9ca3af"></text>
                    </g>
                    <g class="flowNode" id="t1Rack2">
                      <rect x="10" y="95" width="70" height="40" rx="4" class="flowRack"/>
                      <text x="45" y="110" text-anchor="middle" class="flowLabel" id="t1R2Label" font-size="9" font-weight="600">P-R · JRP</text>
                      <text x="45" y="125" text-anchor="middle" class="flowLabel" id="t1R2Jrp" font-size="8" fill="#9ca3af"></text>
                    </g>
                    <g class="flowNode" id="t1Rack3">
                      <rect x="10" y="140" width="70" height="40" rx="4" class="flowRack"/>
                      <text x="45" y="155" text-anchor="middle" class="flowLabel" id="t1R3Label" font-size="9" font-weight="600">P-R · JRP</text>
                      <text x="45" y="170" text-anchor="middle" class="flowLabel" id="t1R3Jrp" font-size="8" fill="#9ca3af"></text>
                    </g>
                    <g class="flowNode" id="t1Rack4">
                      <rect x="10" y="185" width="70" height="40" rx="4" class="flowRack"/>
                      <text x="45" y="200" text-anchor="middle" class="flowLabel" id="t1R4Label" font-size="9" font-weight="600">P-R · JRP</text>
                      <text x="45" y="215" text-anchor="middle" class="flowLabel" id="t1R4Jrp" font-size="8" fill="#9ca3af"></text>
                    </g>
                  </g>
                  
                  <!-- Arrows from T1 racks (may be 1 or 2 depending on JRP pair) -->
                  <g id="t1ToMiniArrows">
                    <path id="t1Arrow1" class="flowPath inactive" d="M 80 67 L 180 120" marker-end="url(#arrowhead)"/>
                    <path id="t1Arrow2" class="flowPath inactive" d="M 80 112 L 180 120" marker-end="url(#arrowhead)"/>
                    <path id="t1Arrow3" class="flowPath inactive" d="M 80 157 L 180 120" marker-end="url(#arrowhead)"/>
                    <path id="t1Arrow4" class="flowPath inactive" d="M 80 202 L 180 120" marker-end="url(#arrowhead)"/>
                  </g>
                  
                  <!-- Arrow marker definitions (multiple colors) -->
                  <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                      <polygon points="0 0, 10 3, 0 6" fill="#3b82f6"/>
                    </marker>
                    <marker id="arrowhead1" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                      <polygon points="0 0, 10 3, 0 6" fill="#3b82f6"/>
                    </marker>
                    <marker id="arrowhead2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                      <polygon points="0 0, 10 3, 0 6" fill="#ea580c"/>
                    </marker>
                    <marker id="arrowhead3" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                      <polygon points="0 0, 10 3, 0 6" fill="#22c55e"/>
                    </marker>
            <marker id="arrowhead4" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#78350f"/>
            </marker>
            <marker id="arrowhead5" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#9ca3af"/>
            </marker>
            <marker id="arrowhead6" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#ffffff"/>
            </marker>
            <marker id="arrowhead7" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#dc2626"/>
            </marker>
            <marker id="arrowhead8" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#000000"/>
            </marker>
          </defs>
                  
                  <!-- Mini-Rack MMC (merged from T1 JRPs) -->
                  <g class="flowNode" id="miniRackNode">
                    <rect x="180" y="100" width="80" height="45" rx="4" class="flowRack" id="miniRackRect"/>
                    <text x="220" y="95" text-anchor="middle" class="flowLabel" font-size="13" font-weight="700">Mini-Rack</text>
                    <text x="220" y="115" text-anchor="middle" class="flowLabel" font-size="10" font-weight="600">MMC</text>
                    <text x="220" y="130" text-anchor="middle" class="flowLabel" id="mmcLabel" font-size="11" font-weight="700">MMC</text>
                    <circle cx="260" cy="120" r="4" fill="#f59e0b" id="miniRackPort"/>
                  </g>
                  
                  <!-- Trunk Cable to NDF -->
                  <path id="trunkPath" class="flowCable inactive" d="M 260 120 Q 340 100 400 80 Q 440 80 470 80" stroke-dasharray="6 3"/>
                  
                  <!-- NDF with 4 cables -->
                  <g class="flowNode" id="ndfNode">
                    <rect x="470" y="50" width="100" height="70" rx="4" class="flowRack" id="ndfRect"/>
                    <text x="520" y="40" text-anchor="middle" class="flowLabel" font-size="13" font-weight="700">NDF (4 MMC * 8MPO)</text>
                    <text x="520" y="60" text-anchor="middle" class="flowLabel" font-size="10" font-weight="600">RU · MMC</text>
                    <text x="520" y="78" text-anchor="middle" class="flowLabel" id="ndfLabel" font-size="11" font-weight="700">RU · MMC</text>
                    <text x="520" y="95" text-anchor="middle" class="flowLabel" id="ndfCableLabel" font-size="9" font-weight="600" fill="#9ca3af">cable</text>
                    
                    <!-- 4 input cables from trunk -->
                    <circle cx="470" cy="70" r="4" fill="#10b981"/>
                    <circle cx="470" cy="80" r="4" fill="#10b981"/>
                    <circle cx="470" cy="90" r="4" fill="#10b981"/>
                    <circle cx="470" cy="100" r="4" fill="#10b981"/>
                    
                    <!-- 4 output cables to T2 -->
                    <circle cx="570" cy="70" r="4" fill="#3b82f6"/>
                    <circle cx="570" cy="80" r="4" fill="#3b82f6"/>
                    <circle cx="570" cy="90" r="4" fill="#3b82f6"/>
                    <circle cx="570" cy="100" r="4" fill="#3b82f6"/>
                  </g>
                  
                  <!-- Mesh Shuffle (8 dotted paths from NDF to T2) -->
                  <g id="ndfToT2Paths">
                    <path id="ndfToT2Path1" class="flowPath active" d="M 570 80 Q 660 70 750 80" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                    <path id="ndfToT2Path2" class="flowPath active" d="M 570 85 Q 660 140 750 170" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                    <path id="ndfToT2Path3" class="flowPath active" d="M 570 90 Q 660 210 750 260" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                    <path id="ndfToT2Path4" class="flowPath active" d="M 570 95 Q 660 280 750 350" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                    <path id="ndfToT2Path5" class="flowPath active" d="M 570 100 Q 660 350 750 440" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                    <path id="ndfToT2Path6" class="flowPath active" d="M 570 105 Q 660 420 750 530" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                    <path id="ndfToT2Path7" class="flowPath active" d="M 570 110 Q 660 490 750 620" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                    <path id="ndfToT2Path8" class="flowPath active" d="M 570 115 Q 660 560 750 710" marker-end="url(#arrowhead)" stroke-dasharray="6 3" stroke="#9ca3af" opacity="0.8"/>
                  </g>
                  
                  <!-- Associated T2 Channels (8 channels - Vertical Stack) -->
                  <g id="associatedT2Channels">
                    <text x="810" y="30" text-anchor="middle" class="flowLabel" font-size="12" font-weight="700" fill="#9ca3af">T2 Channels (T1 JRP-Channel Mapping)</text>
                    
                    <g class="flowNode" id="t2Channel1">
                      <rect x="750" y="40" width="140" height="80" rx="10" class="flowRack" id="t2Rect1"/>
                      <text x="758" y="65" text-anchor="start" class="flowLabel" id="t2Ch1Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="85" text-anchor="start" class="flowLabel" id="t2Ch1Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="68" text-anchor="end" class="flowLabel" id="t2Ch1T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                    <g class="flowNode" id="t2Channel2">
                      <rect x="750" y="130" width="140" height="80" rx="10" class="flowRack" id="t2Rect2"/>
                      <text x="758" y="155" text-anchor="start" class="flowLabel" id="t2Ch2Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="175" text-anchor="start" class="flowLabel" id="t2Ch2Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="158" text-anchor="end" class="flowLabel" id="t2Ch2T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                    <g class="flowNode" id="t2Channel3">
                      <rect x="750" y="220" width="140" height="80" rx="10" class="flowRack" id="t2Rect3"/>
                      <text x="758" y="245" text-anchor="start" class="flowLabel" id="t2Ch3Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="265" text-anchor="start" class="flowLabel" id="t2Ch3Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="248" text-anchor="end" class="flowLabel" id="t2Ch3T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                    <g class="flowNode" id="t2Channel4">
                      <rect x="750" y="310" width="140" height="80" rx="10" class="flowRack" id="t2Rect4"/>
                      <text x="758" y="335" text-anchor="start" class="flowLabel" id="t2Ch4Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="355" text-anchor="start" class="flowLabel" id="t2Ch4Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="338" text-anchor="end" class="flowLabel" id="t2Ch4T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                    
                    <g class="flowNode" id="t2Channel5">
                      <rect x="750" y="400" width="140" height="80" rx="10" class="flowRack" id="t2Rect5"/>
                      <text x="758" y="425" text-anchor="start" class="flowLabel" id="t2Ch5Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="445" text-anchor="start" class="flowLabel" id="t2Ch5Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="428" text-anchor="end" class="flowLabel" id="t2Ch5T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                    <g class="flowNode" id="t2Channel6">
                      <rect x="750" y="490" width="140" height="80" rx="10" class="flowRack" id="t2Rect6"/>
                      <text x="758" y="515" text-anchor="start" class="flowLabel" id="t2Ch6Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="535" text-anchor="start" class="flowLabel" id="t2Ch6Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="518" text-anchor="end" class="flowLabel" id="t2Ch6T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                    <g class="flowNode" id="t2Channel7">
                      <rect x="750" y="580" width="140" height="80" rx="10" class="flowRack" id="t2Rect7"/>
                      <text x="758" y="605" text-anchor="start" class="flowLabel" id="t2Ch7Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="625" text-anchor="start" class="flowLabel" id="t2Ch7Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="608" text-anchor="end" class="flowLabel" id="t2Ch7T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                    <g class="flowNode" id="t2Channel8">
                      <rect x="750" y="670" width="140" height="80" rx="10" class="flowRack" id="t2Rect8"/>
                      <text x="758" y="695" text-anchor="start" class="flowLabel" id="t2Ch8Label" font-size="12" font-weight="700" fill="white">P#-T2-R#</text>
                      <text x="758" y="715" text-anchor="start" class="flowLabel" id="t2Ch8Jrp" font-size="11" font-weight="600" fill="white">JRP #-#</text>
                      <text x="882" y="698" text-anchor="end" class="flowLabel" id="t2Ch8T1Info" font-size="9" fill="white" font-weight="700" opacity="0.8">T1:--</text>
                    </g>
                  </g>
                  
                  <!-- Main flow paths (trunk cable section) -->
                  <path id="miniToNdfPath" class="flowPath inactive" d="M 260 120 Q 340 100 400 80 Q 440 80 460 80 L 470 80"/>
                </svg>
              </div>
            </div>
            <div id="t2Tab" class="tabPane glassMorphism">
        <div id="outT2" class="t2Hero" style="display:none;">
          <div class="title" id="t2Title">T2 Uplink <span id="t2Tick" class="tick">✓</span></div>
          <div class="row" style="margin-top:6px;">
            <div class="kv t2Emph"><b>Rack Unit</b><span class="value" id="t2RU"></span></div>
            <div class="kv t2Emph"><b>JRP</b><span class="value" id="t2JRP"></span></div>
            <div class="kv t2Emph"><b>Channel</b><span class="value" id="t2CH"></span></div>
            <div class="kv"><b>Plane</b><span class="value" id="t2Plane"></span></div>
          </div>
          <div class="actions" style="margin-top:12px;">
            <button class="secondary" id="copyT2">Copy T2 details</button>
          </div>
          <div class="sub" id="t2Sub"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="historyPanel" class="card" style="margin-top:16px;">
        <h1>Recent Lookups</h1>
        <p class="sub">Last 5 results. Click to re-run.</p>
        <div id="historyList" class="history"></div>
        <div class="actions" style="margin-top:12px;">
          <button class="secondary" id="clearHistory">Clear history</button>
        </div>
      </div>
    </div>
  </div>

  <script>
// Theme: apply on load and enable toggle
(function initTheme(){
  try {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const saved = localStorage.getItem('theme');
    const initial = saved ? saved : (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', initial);
    const fab = document.getElementById('theme-switch');
    if (fab) {
      fab.addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      });
    }
  } catch {}
})();
    function parseFields(dev) {
      const pMatch = dev.match(/-p(\d+)-/i);
      const rMatch = dev.match(/-r(\d+)/i);
      const P = pMatch ? Number(pMatch[1]) : NaN;
      const R = rMatch ? Number(rMatch[1]) : NaN;
      return { P, R };
    }
    
    
    function validate(n, min, max, name) {
      if (Number.isNaN(n)) return name + " is required.";
      if (n < min || n > max) return name + " must be in " + min + "–" + max + ".";
      return "";
    }
    
    function setFieldError(id, msg) {
      const el = document.getElementById(id);
      if (el) el.textContent = msg || '';
    }
    
    // Parse combined JRP/Channel input (format: "30-1" or just "30")
    function parseJRPChannel(input) {
      const trimmed = input.trim();
      if (!trimmed) return { j: NaN, channel: 1, error: '' };
      
      // Check if it contains a dash
      if (trimmed.includes('-')) {
        const parts = trimmed.split('-');
        if (parts.length !== 2) {
          return { j: NaN, channel: NaN, error: 'Invalid format. Use JRP-Channel (e.g., 30-1)' };
        }
        const j = Number(parts[0]);
        const channel = Number(parts[1]);
        if (Number.isNaN(j) || Number.isNaN(channel)) {
          return { j: NaN, channel: NaN, error: 'JRP and Channel must be numbers' };
        }
        return { j, channel, error: '' };
      } else {
        // No dash, treat as JRP only, default channel to 1
        const j = Number(trimmed);
        if (Number.isNaN(j)) {
          return { j: NaN, channel: NaN, error: 'JRP must be a number' };
        }
        return { j, channel: 1, error: '' };
      }
    }
    
    function liveValidate() {
      const dev = document.getElementById('dev').value.trim();
      const jrpInput = document.getElementById('jrp').value.trim();
      const { j, channel, error: jrpParseError } = parseJRPChannel(jrpInput);
      const { P, R } = parseFields(dev);
    
      const devErr = dev && !dev.toLowerCase().includes('-t1-') ? 'Device must include -t1-.' : (!dev ? '' : '');
      const pErr = validate(P, 1, 16, 'Switch number (p#)');
      const rErr = validate(R, 1, 128, 'Rack number (r#)');
      const jErr = jrpParseError || validate(j, 17, 32, 'JRP / Port');
      const cErr = validate(channel, 1, 4, 'Channel');
    
      setFieldError('errDev', dev ? (devErr || '') : '');
      setFieldError('errJrp', jrpParseError || jErr || cErr ? (jrpParseError || jErr || cErr) : '');
    
      const hasErrors = Boolean(devErr || pErr || rErr || jrpParseError || jErr || cErr || !dev);
      const calcBtn = document.getElementById('calc');
      if (calcBtn) calcBtn.disabled = hasErrors;
    }
    
    function compute() {
    console.log('=== compute() called ===');
      const dev = document.getElementById('dev').value.trim();
    const jrpInput = document.getElementById('jrp').value.trim();
    const { j, channel, error: jrpParseError } = parseJRPChannel(jrpInput);
      const { P, R } = parseFields(dev);
    console.log(`Input: dev="${dev}", jrpInput="${jrpInput}", parsed: j=${j}, channel=${channel}, P=${P}, R=${R}`);
      
      // NDF Mapping supported for Racks 1–42, 51, 61–85, 86–96, 99–100, 101–102, 106–107, 111–112, 114
      const isExplicitlyMapped = (R >= 1 && R <= 42) || (R === 51) || 
                           (R >= 61 && R <= 70) || (R >= 71 && R <= 79) || 
                           (R >= 80 && R <= 85) || (R >= 86 && R <= 96) || (R >= 99 && R <= 100) || 
                           (R === 101) || (R === 102) || (R === 106) || (R === 107) || (R === 111) || (R === 112) || (R === 114);
      const allowNDF = isExplicitlyMapped; 
      
      if (!dev.toLowerCase().includes("-t1-")) {
        const errorBox = document.getElementById('error');
        const out = document.getElementById('out');
        errorBox.textContent = "Please enter a T1 device name (e.g., sbn100-104-es-m1-p5-t1-r89)";
        errorBox.style.display = 'block';
        out.style.display = 'none';
        const outT2 = document.getElementById('outT2');
        if (outT2) outT2.style.display = 'none';
        return;
      }
    
      let errs = [];
      if (!dev) errs.push("Device name is required.");
      if (jrpParseError) errs.push(jrpParseError);
      errs.push(validate(P, 1, 16, "Switch number (p#)"));
      errs.push(validate(R, 1, 128, "Rack number (r#)"));
      errs.push(validate(j, 17, 32, "JRP / Port"));
      errs.push(validate(channel, 1, 4, "Channel"));
      errs = errs.filter(Boolean);
    
      const errorBox = document.getElementById('error');
      const out = document.getElementById('out');
    
      if (errs.length) {
        errorBox.textContent = errs.join(" ");
        errorBox.style.display = 'block';
        out.style.display = 'none';
        const outT2 = document.getElementById('outT2');
        if (outT2) outT2.style.display = 'none';
        return;
      } else {
        errorBox.style.display = 'none';
      }
    
      const k = Math.floor((P - 1) / 2);
      const block_start = 18 * k + 1;
      const offset = (P % 2 === 0) ? 8 : 0;
      const i = Math.floor((j - 17) / 2);
      const MMC = block_start + offset + i;
      const Spare1 = 18 * k + 17;
      const Spare2 = 18 * k + 18;
    
      // ───────────── T2 Mapping Logic ─────────────
      const RU_T2 = 4 * (j - 17) + channel;      // 1–64
      const JRP_T2 = Math.floor((R - 1) / 4) + 1; // 1–32
      const CH_T2 = ((R - 1) % 4) + 1;            // 1–4
      const PLANE_T2 = P;                         // same as P
    
      // ───────────── NDF Mapping Logic (Updated for R1-R29, R41-R42) ─────────────
      if (allowNDF) {
        let NDF_MMC = null;
        let NDF_range = null;
        let cable = null;
    
        // Initialize NDF_GROUP to 0 or use a fallback value.
        let NDF_GROUP = 0; 
    
        // 1. Determine NDF Group (Custom Mapping for RU41/RU39 Racks)
        if (R >= 1 && R <= 24) {
          // Logic for Racks 1-24 (RU45, RU44, RU43)
          NDF_GROUP = Math.ceil(R / 4);
        } else if (R >= 25 && R <= 28) {
            // Racks 25, 26, 27, 28 map to NDF Group 7 (RU41)
            NDF_GROUP = 7;
        } else if (R === 29) {
            // Rack 29 maps explicitly to NDF Group 8 (RU41)
            NDF_GROUP = 8;
        } else if (R >= 30 && R <= 32) {
            // R30, R31, R32 map to NDF Group 8 (RU39)
            NDF_GROUP = 8;
        } else if (R >= 33 && R <= 35) {
            // R33, R34, R35 map to NDF Group 9 (RU39)
            NDF_GROUP = 9;
        } else if (R === 36) {
            // R36 maps to NDF Group 9 (RU37)
            NDF_GROUP = 9;
        } else if (R >= 37 && R <= 40) {
            // R37, R38, R39, R40 map to NDF Group 10 (RU37)
            NDF_GROUP = 10;
        } else if (R >= 41 && R <= 42) {
            // Racks 41, 42 map explicitly to NDF Group 11 (RU41)
            NDF_GROUP = 11;
        } else if (R === 51) {
            // R51 maps explicitly to NDF Group 13 (RU39)
            NDF_GROUP = 13;
        } else if (R === 101) {
            // R101 maps to NDF Group 26 (RU39)
            NDF_GROUP = 26;
        // RU26/RU28 Mappings (Groups 16-20)
        } else if (R === 63) {
            // R63 maps to NDF Group 16 (RU26)
            NDF_GROUP = 16;
        } else if (R === 62) {
            // R62 maps to NDF Group 16 (RU28)
            NDF_GROUP = 16;
        } else if (R === 64) {
            // R64 maps to NDF Group 16 (RU28)
            NDF_GROUP = 16;
        } else if (R === 65) {
            // R65 maps to NDF Group 17 (RU26)
            NDF_GROUP = 17;
        } else if (R === 66) {
            // R66 maps to NDF Group 17 (RU26)
            NDF_GROUP = 17;
        } else if (R === 67) {
            // R67 maps to NDF Group 17 (RU26)
            NDF_GROUP = 17;
        } else if (R === 68) {
            // R68 maps to NDF Group 17 (RU28)
            NDF_GROUP = 17;
        } else if (R === 69) {
            // R69 maps to NDF Group 18 (RU28)
            NDF_GROUP = 18;
        } else if (R === 70) {
            // R70 maps to NDF Group 18 (RU26)
            NDF_GROUP = 18;
        } else if (R === 74) {
            // R74 maps to NDF Group 19 (RU26)
            NDF_GROUP = 19;
        } else if (R === 76) {
            // R76 maps to NDF Group 19 (RU26)
            NDF_GROUP = 19;
        } else if (R === 79) {
            // R79 maps to NDF Group 20 (RU26)
            NDF_GROUP = 20;
        // RU24 Mappings (Groups 18, 19, 20, 21)
        } else if (R === 77) {
            // R77 maps to NDF Group 20 (RU24)
            NDF_GROUP = 20;
        } else if (R === 75) {
            // R75 maps to NDF Group 19 (RU24)
            NDF_GROUP = 19;
        } else if (R === 72) {
            // R72 maps to NDF Group 18 (RU24)
            NDF_GROUP = 18;
        } else if (R === 73) {
            // R73 maps to NDF Group 19 (RU24)
            NDF_GROUP = 19;
        } else if (R === 78) {
            // R78 maps to NDF Group 20 (RU24)
            NDF_GROUP = 20;
        } else if (R === 71) {
            // R71 maps to NDF Group 18 (RU24)
            NDF_GROUP = 18;
        } else if (R === 81) {
            // R81 maps to NDF Group 21 (RU24)
            NDF_GROUP = 21;
        } else if (R === 82) {
            // R82 maps to NDF Group 21 (RU24)
            NDF_GROUP = 21;
        // RU22 Mappings (Groups 20, 21, 22, 23, 24, 25, 29)
        } else if (R === 114) {
            // R114 maps to NDF Group 29 (RU22)
            NDF_GROUP = 29;
        } else if (R === 98) {
            // R98 maps to NDF Group 25 (RU22)
            NDF_GROUP = 25;
        } else if (R === 80) {
            // R80 maps to NDF Group 20 (RU22)
            NDF_GROUP = 20;
        } else if (R === 83) {
            // R83 maps to NDF Group 21 (RU22)
            NDF_GROUP = 21;
        } else if (R === 93) {
            // R93 maps to NDF Group 24 (RU22)
            NDF_GROUP = 24;
        } else if (R === 97) {
            // R97 maps to NDF Group 25 (RU22)
            NDF_GROUP = 25;
        } else if (R === 89) {
            // R89 maps to NDF Group 23 (RU22)
            NDF_GROUP = 23;
        } else if (R === 88) {
            // R88 maps to NDF Group 22 (RU22) - corrected from R96
            NDF_GROUP = 22;
        // RU20 Mappings (Groups 21, 22, 23, 24, 25, 27)
        } else if (R === 94) {
            // R94 maps to NDF Group 24 (RU20)
            NDF_GROUP = 24;
        } else if (R === 99 || R === 100) {
            // R99, R100 map to NDF Group 25 (RU20)
            NDF_GROUP = 25;
        } else if (R === 107) {
            // R107 maps to NDF Group 27 (RU20)
            NDF_GROUP = 27;
        } else if (R === 84) {
            // R84 maps to NDF Group 21 (RU20)
            NDF_GROUP = 21;
        } else if (R === 85) {
            // R85 maps to NDF Group 22 (RU20)
            NDF_GROUP = 22;
        } else if (R === 87) {
            // R87 maps to NDF Group 22 (RU20)
            NDF_GROUP = 22;
        } else if (R === 90) {
            // R90 maps to NDF Group 23 (RU20)
            NDF_GROUP = 23;
        // RU18 Mappings (Groups 22, 23, 24, 26, 27, 28)
        } else if (R === 95) {
            // R95 maps to NDF Group 24 (RU18)
            NDF_GROUP = 24;
        } else if (R === 92) {
            // R92 maps to NDF Group 23 (RU18)
            NDF_GROUP = 23;
        } else if (R === 112) {
            // R112 maps to NDF Group 28 (RU18)
            NDF_GROUP = 28;
        } else if (R === 91) {
            // R91 maps to NDF Group 23 (RU18)
            NDF_GROUP = 23;
        } else if (R === 106) {
            // R106 maps to NDF Group 27 (RU18)
            NDF_GROUP = 27;
        } else if (R === 86) {
            // R86 maps to NDF Group 22 (RU18)
            NDF_GROUP = 22;
        } else if (R === 102) {
            // R102 maps to NDF Group 26 (RU18)
            NDF_GROUP = 26;
        } else if (R === 96) {
            // R96 maps to NDF Group 24 (RU18) - Note: was RU22, now RU18
            NDF_GROUP = 24;
        // RU16 Mappings (Group 28)
        } else if (R === 111) {
            // R111 maps to NDF Group 28 (RU16)
            NDF_GROUP = 28;
        } 
        
        // Fallback: If no explicit mapping found NDF_GROUP remains 0
        
        const key = `${NDF_GROUP}-${CH_T2}`;
    
        // 2. Determine NDF Rack Unit (RU) based on the rack number (Group 8 has mixed RU41/RU39)
        let NDF_RU = '—';
        if (NDF_GROUP >= 1 && NDF_GROUP <= 6) {
          // Groups 1-6: Standard mapping
          const standardRU = { 1: 45, 2: 45, 3: 44, 4: 44, 5: 43, 6: 43 };
          NDF_RU = standardRU[NDF_GROUP] || '—';
        } else if (NDF_GROUP === 7) {
          NDF_RU = 41; // RU41 for R25-R28
        } else if (NDF_GROUP === 8) {
          // Group 8: Mixed - R29 is RU41, R30-R32 are RU39
          NDF_RU = (R === 29) ? 41 : 39;
        } else if (NDF_GROUP === 9) {
          // Group 9: Mixed - R36 is RU37, R33-R35 are RU39
          NDF_RU = (R === 36) ? 37 : 39;
        } else if (NDF_GROUP === 10) {
          NDF_RU = 37; // RU37 for R37-R40
        } else if (NDF_GROUP === 11) {
          NDF_RU = 41; // RU41 for R41-R42
        } else if (NDF_GROUP === 13) {
          NDF_RU = 39; // RU39 for R51
        } else if (NDF_GROUP === 26) {
          if (R === 101) {
            NDF_RU = 39; // R101=RU39
          } else if (R === 102) {
            NDF_RU = 18; // R102=RU18
          }
        } else if (NDF_GROUP >= 16 && NDF_GROUP <= 21) {
          // Groups 16-21: Mixed RU28, RU26, RU24, RU22, and RU20
          if (NDF_GROUP === 16) {
            if (R === 63) {
              NDF_RU = 26; // R63=RU26
            } else if (R === 62 || R === 64) {
              NDF_RU = 28; // R62, R64=RU28
            }
          } else if (NDF_GROUP === 17) {
            NDF_RU = (R >= 65 && R <= 67) ? 26 : 28; // R65-R67=RU26, R68=RU28
          } else if (NDF_GROUP === 18) {
            if (R === 69) {
              NDF_RU = 28; // R69=RU28
            } else if (R === 70) {
              NDF_RU = 26; // R70=RU26
            } else if (R === 71 || R === 72) {
              NDF_RU = 24; // R71-R72=RU24
            }
          } else if (NDF_GROUP === 19) {
            if (R === 74 || R === 76) {
              NDF_RU = 26; // R74, R76=RU26
            } else if (R === 75 || R === 73) {
              NDF_RU = 24; // R75, R73=RU24
            }
          } else if (NDF_GROUP === 20) {
            if (R === 79) {
              NDF_RU = 26; // R79=RU26
            } else if (R === 77 || R === 78) {
              NDF_RU = 24; // R77-R78=RU24
            } else if (R === 80) {
              NDF_RU = 22; // R80=RU22
            }
          } else if (NDF_GROUP === 21) {
            if (R === 81 || R === 82) {
              NDF_RU = 24; // R81-R82=RU24
            } else if (R === 83) {
              NDF_RU = 22; // R83=RU22
            } else if (R === 84) {
              NDF_RU = 20; // R84=RU20
            }
          }
        } else if (NDF_GROUP >= 22 && NDF_GROUP <= 29) {
          // Groups 22-29: Mixed RU22, RU20, and RU18
          if (NDF_GROUP === 22) {
            if (R === 88) {
              NDF_RU = 22; // R88=RU22
            } else if (R === 85 || R === 87) {
              NDF_RU = 20; // R85, R87=RU20
            } else if (R === 86) {
              NDF_RU = 18; // R86=RU18
            }
          } else if (NDF_GROUP === 23) {
            if (R === 89) {
              NDF_RU = 22; // R89=RU22
            } else if (R === 90) {
              NDF_RU = 20; // R90=RU20
            } else if (R === 91 || R === 92) {
              NDF_RU = 18; // R91, R92=RU18
            }
          } else if (NDF_GROUP === 24) {
            if (R === 93) {
              NDF_RU = 22; // R93=RU22
            } else if (R === 94) {
              NDF_RU = 20; // R94=RU20
            } else if (R === 95 || R === 96) {
              NDF_RU = 18; // R95, R96=RU18
            }
          } else if (NDF_GROUP === 25) {
            if (R === 97 || R === 98) {
              NDF_RU = 22; // R97, R98=RU22
            } else if (R === 99 || R === 100) {
              NDF_RU = 20; // R99, R100=RU20
            }
          } else if (NDF_GROUP === 26) {
            NDF_RU = 18; // R102=RU18
          } else if (NDF_GROUP === 27) {
            if (R === 107) {
              NDF_RU = 20; // R107=RU20
            } else if (R === 106) {
              NDF_RU = 18; // R106=RU18
            }
          } else if (NDF_GROUP === 28) {
            if (R === 111) {
              NDF_RU = 16; // R111=RU16
            } else if (R === 112) {
              NDF_RU = 18; // R112=RU18
            }
          } else if (NDF_GROUP === 29) {
            NDF_RU = 22; // R114=RU22
          }
        } 
    
        // 3. Table for NDF range blocks (Expanded for RU28)
        const ndfRanges = {
          // STANDARD REPEATING RANGES (Groups 1-6)
          "1-1": [1,16], "3-1": [1,16], "5-1": [1,16],
          "1-2": [19,34], "3-2": [19,34], "5-2": [19,34],
          "1-3": [37,52], "3-3": [37,52], "5-3": [37,52],
          "1-4": [55,70], "3-4": [55,70], "5-4": [55,70],
          "2-1": [73,88], "4-1": [73,88], "6-1": [73,88],
          "2-2": [91,106], "4-2": [91,106], "6-2": [91,106],
          "2-3": [109,124], "4-3": [109,124], "6-3": [109,124],
          "2-4": [127,142], "4-4": [127,142], "6-4": [127,142],
          
          // RU41/RU39 SPECIFIC RANGES (Groups 7, 8, 9, 11, 13)
          "11-1": [1,16],  
          "7-1": [37,52],   
          "7-2": [55,70],   
          "11-2": [73,88], 
          "7-3": [91,106],  
          "7-4": [109,124], 
          "8-1": [127,142],  // RU41: R29 
          
          "8-2": [19,34],    // RU39: R30 (CH2)
          "8-3": [37,52],    // RU39: R31 (CH3)
          "8-4": [55,70],    // RU39: R32 (CH4)
          "9-1": [73,88],    // RU39: R33 (CH1)
          "9-2": [91,106],   // RU39: R34 (CH2)
          "13-3": [109,124],  // RU39: R51 (CH3)
          "9-3": [127,142],   // RU39: R35 (CH3)
          "26-1": [1,16],     // RU39: R101 (CH1)
          
          // RU37 (Group 9, 10)
          "9-4": [1,16],      // RU37: R36
          "10-1": [19,34],    // RU37: R37
          "10-2": [55,70],    // RU37: R38
          "10-3": [73,88],    // RU37: R39
          "10-4": [91,106],   // RU37: R40
          
          // RU28 (Groups 16, 17)
          "16-2": [109,124],  // RU28: R62 (CH2)
          "16-4": [127,142],  // RU28: R64 (CH4)
          "17-4": [73,88],    // RU28: R68 (CH4)
          
          // RU26 (Groups 16, 17, 18, 19, 20)
          "17-2": [1,16],     // RU26: R66 (CH2)
          "17-1": [19,34],    // RU26: R65 (CH1)
          "17-3": [37,52],    // RU26: R67 (CH3)
          "16-3": [55,70],    // RU26: R63 (CH3)
          "18-1": [91,106],   // RU28: R69 (CH1)
          "18-2": [73,88],    // RU26: R70 (CH2)
          "20-3": [91,106],   // RU26: R79 (CH3)
          "19-2": [109,124],  // RU26: R74 (CH2)
          "19-4": [127,142],  // RU26: R76 (CH4)
          
          // RU24 (Groups 18, 19, 20, 21)
          "20-1": [1,16],     // RU24: R77 (CH1)
          "19-3": [19,34],    // RU24: R75 (CH3)
          "18-4": [37,52],    // RU24: R72 (CH4)
          "19-1": [55,70],    // RU24: R73 (CH1)
          "20-2": [73,88],    // RU24: R78 (CH2)
          "18-3": [91,106],   // RU24: R71 (CH3)
          "21-1": [109,124],  // RU24: R81 (CH1)
          "21-2": [127,142],  // RU24: R82 (CH2)
          
          // RU22 (Groups 20, 21, 22, 23, 24, 25, 29)
          "29-2": [1,16],     // RU22: R114 (CH2)
          "25-2": [19,34],    // RU22: R98 (CH2)
          "20-4": [37,52],    // RU22: R80 (CH4)
          "21-3": [55,70],    // RU22: R83 (CH3)
          "24-1": [73,88],    // RU22: R93 (CH1)
          "25-1": [91,106],   // RU22: R97 (CH1)
          "23-1": [109,124],  // RU22: R89 (CH1)
          "22-4": [127,142],  // RU22: R88 (CH4) - corrected from R96
          
          // RU20 (Groups 21, 22, 23, 24, 25, 27)
          "24-2": [1,16],     // RU20: R94 (CH2)
          "25-3": [19,34],    // RU20: R99 (CH3)
          "25-4": [37,52],    // RU20: R100 (CH4)
          "27-3": [55,70],    // RU20: R107 (CH3)
          "21-4": [73,88],    // RU20: R84 (CH4)
          "23-2": [91,106],   // RU20: R90 (CH2)
          "22-3": [109,124],  // RU20: R87 (CH3)
          "22-1": [127,142],  // RU20: R85 (CH1)
          
          // RU18 (Groups 22, 23, 24, 26, 27, 28)
          "24-3": [1,16],     // RU18: R95 (CH3)
          "23-4": [19,34],    // RU18: R92 (CH4)
          "28-4": [37,52],    // RU18: R112 (CH4)
          "23-3": [55,70],    // RU18: R91 (CH3)
          "27-2": [73,88],    // RU18: R106 (CH2)
          "22-2": [91,106],   // RU18: R86 (CH2)
          "24-4": [109,124],  // RU18: R96 (CH4) - Note: was RU22, now RU18
          "26-2": [127,142],  // RU18: R102 (CH2)
          
          // RU16 (Group 28)
          "28-3": [1,16]      // RU16: R111 (CH3)
        };
    
        // Odd/even plane determines lower or upper half of the range
        const pair = ndfRanges[key];
        if (pair && NDF_GROUP > 0) { // Only proceed if a valid group was found
          const [rangeStart, rangeEnd] = pair;
          const span = rangeEnd - rangeStart + 1; // 16
          const half = span / 2; // 8
          const planeType = (P % 2 === 0) ? 'even' : 'odd';
          const base = planeType === 'odd' ? rangeStart : rangeStart + half;
          const activeRange = [base, base + half - 1];
          NDF_range = activeRange;
    
          // Determine cable from T1 JRP
          const t1CableMap = {17:1,18:1,19:2,20:2,21:3,22:3,23:4,24:4,25:5,26:5,27:6,28:6,29:7,30:7,31:8,32:8};
          cable = t1CableMap[j];
    
          // Calculate NDF MMC: start of active range + (cable-1)
          if (cable) NDF_MMC = activeRange[0] + (cable - 1);
          
          // Store results only if we successfully calculated all values
          window._ndfResult = {RU: NDF_RU, MMC: NDF_MMC, Range: NDF_range, Cable: cable, Group: NDF_GROUP };
          // Debug log for successful calculation
          console.log(`✓ NDF → R${R}, Group ${NDF_GROUP}, Key ${key}, Pair found: true, RU ${NDF_RU}, MMC ${NDF_MMC}, Range [${NDF_range[0]}, ${NDF_range[1]}], Plane ${(P%2===0)?'even':'odd'}, Cable ${cable}`);
        } else {
          // No valid pair found - store with null values but keep Group for error message
          window._ndfResult = {RU: NDF_RU, MMC: null, Range: [null, null], Cable: null, Group: NDF_GROUP };
          // Debug log for failed lookup
          console.log(`✗ NDF → R${R}, Group ${NDF_GROUP}, Key ${key}, Pair found: false, RU ${NDF_RU}, MMC null - KEY NOT FOUND IN ndfRanges!`);
        }
      } else {
        window._ndfResult = null;
      }
    
      // Call function to calculate and display all 4 channels
      if (allowNDF && window._ndfResult && window._ndfResult.Group > 0) {
        // Pass core parameters JRP 'j', Switch 'P', and Rack 'R'
        computeNdfChannelSummary(dev, j, P, R);
      } else {
        const summaryWrapper = document.getElementById('ndfChannelSummary');
        if (summaryWrapper) summaryWrapper.style.display = 'none';
      }
    
      document.getElementById('oDev').textContent = dev;
      document.getElementById('oSwitch').textContent = "P" + P;
      document.getElementById('oRack').textContent = "R" + R;
      document.getElementById('oPort').textContent = "JRP " + j;
      document.getElementById('oMMC').textContent = MMC;
      document.getElementById('oSp1').textContent = Spare1;
      document.getElementById('oSp2').textContent = Spare2;
      // Clear previous highlights then emphasize MMC and Spares
      document.querySelectorAll('.kv').forEach(el => el.classList.remove('highlight-primary','highlight-secondary'));
      document.getElementById('oMMC').parentElement.classList.add('highlight-primary');
      document.getElementById('oSp1').parentElement.classList.add('highlight-secondary');
      document.getElementById('oSp2').parentElement.classList.add('highlight-secondary');
      document.getElementById('oNotes').textContent =
        (P % 2 === 0)
          ? "Even switch in pair (offset 8)."
          : "Odd switch in pair (offset 0).";
      const logicComputed = document.getElementById('logicComputed');
      if (logicComputed) {
        logicComputed.textContent = `Computed with: k=${k}, block_start=${block_start}, offset=${offset}, i=${i}.`;
      }
    
      // Show results with subtle transition
      showWithTransition(out);
    
      // Smooth scroll to results
      setTimeout(() => scrollToElement(out, 100), 150);
    
      // Populate T2 concise emphasis with formatted device names
      const t2Title = document.getElementById('t2Title');
      if (t2Title) {
        // Extract base name (everything before -t1-)
        const baseMatch = dev.match(/^(.+)-t1-/i);
        const baseName = baseMatch ? baseMatch[1] : dev.replace(/-t1-.*/i, '');
        
        // Build T2 device name: baseName-t2-r{RU_T2}
        const t2DevName = `${baseName}-t2-r${RU_T2}`;
        
        // Format: T1_device · JRP j-channel <-> T2_device · JRP JRP_T2-CH_T2
        // Preserve the tick mark
        const tickSpan = document.getElementById('t2Tick');
        const tickHtml = tickSpan ? tickSpan.outerHTML : '';
        t2Title.innerHTML = `${dev} · JRP ${j}-${channel} <-> ${t2DevName} · JRP ${JRP_T2}-${CH_T2} ${tickHtml}`;
      }
      document.getElementById('t2RU').textContent = RU_T2;
      document.getElementById('t2JRP').textContent = JRP_T2;
      document.getElementById('t2CH').textContent = CH_T2;
      document.getElementById('t2Plane').textContent = 'P' + PLANE_T2;
      document.getElementById('t2Sub').textContent = '';
      // Show T2 with subtle transition
      const outT2El = document.getElementById('outT2');
      showWithTransition(outT2El);
    
      // ───────────── Display NDF Mapping ─────────────
      const ndf = window._ndfResult;
      const ndfOut = document.getElementById('outNDF');
      const ndfTitle = document.getElementById('ndfTitle');
      const ndfRU = document.getElementById('ndfRU');
      const ndfMMC = document.getElementById('ndfMMC');
      const ndfCable = document.getElementById('ndfCable');
      const ndfRange = document.getElementById('ndfRange');
      const ndfNote = document.getElementById('ndfNote');
      
      if (ndfOut && ndfRU && ndfMMC && ndfCable && ndfRange && ndfNote) {
        showWithTransition(ndfOut);
        ndfOut.classList.remove('show');
        void ndfOut.offsetWidth;
        if (allowNDF && ndf && ndf.MMC != null && ndf.Cable != null && Array.isArray(ndf.Range) && ndf.Range[0] != null && ndf.Range[1] != null) {
          ndfTitle.textContent = 'NDF — Active Mapping';
          ndfRU.textContent = ndf.RU;
          ndfMMC.textContent = ndf.MMC;
          // Apply channel-based color to MMC (channel 1-4 maps to cable colors 1-4)
          ndfMMC.className = 'ndfVal'; // Reset classes
          if (CH_T2 >= 1 && CH_T2 <= 4) {
            ndfMMC.classList.add(`cable${CH_T2}`);
          }
          ndfCable.textContent = ndf.Cable;
          ndfRange.textContent = `${ndf.Range[0]}–${ndf.Range[1]}`;
          // Display uses T2 JRP and Channel
          ndfNote.textContent = `Derived from JRP ${j} (cable ${ndf.Cable}) in JRP_T2 ${JRP_T2}-${CH_T2}.`;
          ndfOut.classList.add('show');
          
          // Update and show data flow diagram
          updateFlowDiagram(dev, P, R, j, channel, MMC, ndf.RU, ndf.MMC, JRP_T2, CH_T2, RU_T2);
        } else {
          ndfTitle.textContent = 'NDF — Under Development';
          
          // Logic to display RU for Racks that are explicitly mapped but don't have a formula
          let displayedRU = '—';
          let tempNDFGroup = 0;
          
          if (R >= 1 && R <= 24) {
            tempNDFGroup = Math.ceil(R / 4);
            const standardRU = { 1: 45, 2: 45, 3: 44, 4: 44, 5: 43, 6: 43 };
            displayedRU = standardRU[tempNDFGroup] || '—';
          } else if (R >= 25 && R <= 28) {
            tempNDFGroup = 7;
            displayedRU = 41; // RU41
          } else if (R === 29) {
            tempNDFGroup = 8;
            displayedRU = 41; // RU41 for R29
          } else if (R >= 30 && R <= 32) {
            tempNDFGroup = 8;
            displayedRU = 39; // RU39 for R30-R32
          } else if (R >= 33 && R <= 35) {
            tempNDFGroup = 9;
            displayedRU = 39; // RU39
          } else if (R === 36) {
            tempNDFGroup = 9;
            displayedRU = 37; // RU37 for R36
          } else if (R >= 37 && R <= 40) {
            tempNDFGroup = 10;
            displayedRU = 37; // RU37 for R37-R40
          } else if (R >= 41 && R <= 42) {
            tempNDFGroup = 11;
            displayedRU = 41; // RU41
          } else if (R === 51) {
            tempNDFGroup = 13;
            displayedRU = 39; // RU39
          } else if (R === 63) {
            tempNDFGroup = 16;
            displayedRU = 26; // RU26 for R63
          } else if (R === 62) {
            tempNDFGroup = 16;
            displayedRU = 28; // RU28 for R62
          } else if (R === 64) {
            tempNDFGroup = 16;
            displayedRU = 28; // RU28 for R64
          } else if (R === 65 || R === 66 || R === 67) {
            tempNDFGroup = 17;
            displayedRU = 26; // RU26 for R65-R67
          } else if (R === 68) {
            tempNDFGroup = 17;
            displayedRU = 28; // RU28 for R68
          } else if (R === 69) {
            tempNDFGroup = 18;
            displayedRU = 28; // RU28 for R69
          } else if (R === 70) {
            tempNDFGroup = 18;
            displayedRU = 26; // RU26 for R70
          } else if (R === 74 || R === 76) {
            tempNDFGroup = 19;
            displayedRU = 26; // RU26 for R74, R76
          } else if (R === 79) {
            tempNDFGroup = 20;
            displayedRU = 26; // RU26 for R79
          } else if (R === 77) {
            tempNDFGroup = 20;
            displayedRU = 24; // RU24 for R77
          } else if (R === 75) {
            tempNDFGroup = 19;
            displayedRU = 24; // RU24 for R75
          } else if (R === 72) {
            tempNDFGroup = 18;
            displayedRU = 24; // RU24 for R72
          } else if (R === 73) {
            tempNDFGroup = 19;
            displayedRU = 24; // RU24 for R73
          } else if (R === 78) {
            tempNDFGroup = 20;
            displayedRU = 24; // RU24 for R78
          } else if (R === 71) {
            tempNDFGroup = 18;
            displayedRU = 24; // RU24 for R71
          } else if (R === 81 || R === 82) {
            tempNDFGroup = 21;
            displayedRU = 24; // RU24 for R81-R82
          } else if (R === 114) {
            tempNDFGroup = 29;
            displayedRU = 22; // RU22 for R114
          } else if (R === 98) {
            tempNDFGroup = 25;
            displayedRU = 22; // RU22 for R98
          } else if (R === 80) {
            tempNDFGroup = 20;
            displayedRU = 22; // RU22 for R80
          } else if (R === 83) {
            tempNDFGroup = 21;
            displayedRU = 22; // RU22 for R83
          } else if (R === 93) {
            tempNDFGroup = 24;
            displayedRU = 22; // RU22 for R93
          } else if (R === 97) {
            tempNDFGroup = 25;
            displayedRU = 22; // RU22 for R97
          } else if (R === 89) {
            tempNDFGroup = 23;
            displayedRU = 22; // RU22 for R89
          } else if (R === 88) {
            tempNDFGroup = 22;
            displayedRU = 22; // RU22 for R88 - corrected from R96
          } else if (R === 94) {
            tempNDFGroup = 24;
            displayedRU = 20; // RU20 for R94
          } else if (R === 99 || R === 100) {
            tempNDFGroup = 25;
            displayedRU = 20; // RU20 for R99-R100
          } else if (R === 107) {
            tempNDFGroup = 27;
            displayedRU = 20; // RU20 for R107
          } else if (R === 84) {
            tempNDFGroup = 21;
            displayedRU = 20; // RU20 for R84
          } else if (R === 85) {
            tempNDFGroup = 22;
            displayedRU = 20; // RU20 for R85
          } else if (R === 87) {
            tempNDFGroup = 22;
            displayedRU = 20; // RU20 for R87
          } else if (R === 90) {
            tempNDFGroup = 23;
            displayedRU = 20; // RU20 for R90
          } else if (R === 95) {
            tempNDFGroup = 24;
            displayedRU = 18; // RU18 for R95
          } else if (R === 92) {
            tempNDFGroup = 23;
            displayedRU = 18; // RU18 for R92
          } else if (R === 112) {
            tempNDFGroup = 28;
            displayedRU = 18; // RU18 for R112
          } else if (R === 91) {
            tempNDFGroup = 23;
            displayedRU = 18; // RU18 for R91
          } else if (R === 106) {
            tempNDFGroup = 27;
            displayedRU = 18; // RU18 for R106
          } else if (R === 86) {
            tempNDFGroup = 22;
            displayedRU = 18; // RU18 for R86
          } else if (R === 102) {
            tempNDFGroup = 26;
            displayedRU = 18; // RU18 for R102
          } else if (R === 101) {
            tempNDFGroup = 26;
            displayedRU = 39; // RU39 for R101
          } else if (R === 96) {
            tempNDFGroup = 24;
            displayedRU = 18; // RU18 for R96 - Note: was RU22, now RU18
          } else if (R === 111) {
            tempNDFGroup = 28;
            displayedRU = 16; // RU16 for R111
          }
          
          // Hide channel summary and flow diagram when main NDF fails
          const summaryWrapper = document.getElementById('ndfChannelSummary');
          if (summaryWrapper) summaryWrapper.style.display = 'none';
          const flowContainer = document.getElementById('flowDiagramContainer');
          if (flowContainer) flowContainer.style.display = 'none';
          
          ndfRU.textContent = (R < 1 || R > 51) ? '—' : displayedRU; 
          ndfMMC.textContent = '—';
          ndfMMC.className = 'ndfVal'; // Clear cable color classes
          ndfCable.textContent = '—';
          ndfRange.textContent = '—';
          const isSupported = allowNDF;
          ndfNote.textContent = !isSupported
            ? `NDF mapping is supported for Racks 1–42, 51, 61–85, 86–96, 99–100, 101–102, 106–107, 111–112, and 114 of T1. R${R} mapping is not defined.`
            : `R${R} found in NDF Group ${window._ndfResult ? window._ndfResult.Group : tempNDFGroup} but an explicit mapping is missing (key ${tempNDFGroup}-${CH_T2}).`;
        }
      }
    
      // Render MMC mini-diagram
      window._currentBlockStart = block_start;
      renderMMCDiagram({ MMC, Spare1, Spare2, blockStart: block_start });
    
      // Show T2 checkmark briefly
      const tick = document.getElementById('t2Tick');
      if (tick) {
        tick.classList.remove('show');
        // force reflow to restart animation
        void tick.offsetWidth;
        tick.classList.add('show');
        setTimeout(() => tick.classList.remove('show'), 900);
      }
    
      window._copyText = `Device ${dev} → MMC ${MMC} (Spare1 ${Spare1}, Spare2 ${Spare2}); Switch P${P}, Rack R${R}, Port JRP${j}; T2 → Plane P${PLANE_T2}, RU ${RU_T2}, JRP ${JRP_T2}, CH ${CH_T2}.`;
    
      // Update permalink
      try {
        const params = new URLSearchParams();
        params.set('dev', dev);
        params.set('jrp', String(j));
        params.set('channel', String(channel));
        history.replaceState(null, '', location.pathname + '?' + params.toString());
      } catch {}
    
      // Update recent history
      try {
        const entry = {
          dev,
          j,
          channel,
          P,
          R,
          MMC,
          Spare1,
          Spare2,
          t2: { RU: RU_T2, JRP: JRP_T2, CH: CH_T2, Plane: PLANE_T2 },
          ts: Date.now()
        };
        addToHistory(entry);
        renderHistory();
      } catch {}
    }
    
    function computeNdfChannelSummary(dev, j, P, R) {
      const summaryList = document.getElementById('ndfSummaryList');
      const summaryWrapper = document.getElementById('ndfChannelSummary');
      const ndfT2JrpNumEl = document.getElementById('ndfT2JrpNum');
      
      summaryList.innerHTML = '';
      
      // --- Define Mapping Constants (Updated) ---
      // Note: Group 8 has mixed RU (R29=RU41, R30-R32=RU39), so we determine RU by rack number
      const ndfRanges = {
          "1-1": [1,16], "3-1": [1,16], "5-1": [1,16], "1-2": [19,34], "3-2": [19,34], "5-2": [19,34],
          "1-3": [37,52], "3-3": [37,52], "5-3": [37,52], "1-4": [55,70], "3-4": [55,70], "5-4": [55,70],
          "2-1": [73,88], "4-1": [73,88], "6-1": [73,88], "2-2": [91,106], "4-2": [91,106], "6-2": [91,106],
          "2-3": [109,124], "4-3": [109,124], "6-3": [109,124], "2-4": [127,142], "4-4": [127,142], "6-4": [127,142],
          "11-1": [1,16], "7-1": [37,52], "7-2": [55,70], "11-2": [73,88], 
          "7-3": [91,106], "7-4": [109,124], "8-1": [127,142], 
          "8-2": [19,34], "8-3": [37,52], "8-4": [55,70],
          "9-1": [73,88], "9-2": [91,106], "13-3": [109,124], "9-3": [127,142],
          // RU37 (Group 9, 10)
          "9-4": [1,16],      // RU37: R36
          "10-1": [19,34],    // RU37: R37
          "10-2": [55,70],    // RU37: R38
          "10-3": [73,88],    // RU37: R39
          "10-4": [91,106],   // RU37: R40
          
          // RU28 (Groups 16, 17)
          "16-2": [109,124],  // RU28: R62 (CH2)
          "16-4": [127,142],  // RU28: R64 (CH4)
          "17-4": [73,88],    // RU28: R68 (CH4)
          
          // RU26 (Groups 16, 17, 18, 19, 20)
          "17-2": [1,16],     // RU26: R66 (CH2)
          "17-1": [19,34],    // RU26: R65 (CH1)
          "17-3": [37,52],    // RU26: R67 (CH3)
          "16-3": [55,70],    // RU26: R63 (CH3)
          "18-1": [91,106],   // RU28: R69 (CH1)
          "18-2": [73,88],    // RU26: R70 (CH2)
          "20-3": [91,106],   // RU26: R79 (CH3)
          "19-2": [109,124],  // RU26: R74 (CH2)
          "19-4": [127,142],  // RU26: R76 (CH4)
          
          // RU24 (Groups 18, 19, 20, 21)
          "20-1": [1,16],     // RU24: R77 (CH1)
          "19-3": [19,34],    // RU24: R75 (CH3)
          "18-4": [37,52],    // RU24: R72 (CH4)
          "19-1": [55,70],    // RU24: R73 (CH1)
          "20-2": [73,88],    // RU24: R78 (CH2)
          "18-3": [91,106],   // RU24: R71 (CH3)
          "21-1": [109,124],  // RU24: R81 (CH1)
          "21-2": [127,142],  // RU24: R82 (CH2)
          
          // RU22 (Groups 20, 21, 22, 23, 24, 25, 29)
          "29-2": [1,16],     // RU22: R114 (CH2)
          "25-2": [19,34],    // RU22: R98 (CH2)
          "20-4": [37,52],    // RU22: R80 (CH4)
          "21-3": [55,70],    // RU22: R83 (CH3)
          "24-1": [73,88],    // RU22: R93 (CH1)
          "25-1": [91,106],   // RU22: R97 (CH1)
          "23-1": [109,124],  // RU22: R89 (CH1)
          "22-4": [127,142],  // RU22: R88 (CH4) - corrected from R96
          
          // RU20 (Groups 21, 22, 23, 24, 25, 27)
          "24-2": [1,16],     // RU20: R94 (CH2)
          "25-3": [19,34],    // RU20: R99 (CH3)
          "25-4": [37,52],    // RU20: R100 (CH4)
          "27-3": [55,70],    // RU20: R107 (CH3)
          "21-4": [73,88],    // RU20: R84 (CH4)
          "23-2": [91,106],   // RU20: R90 (CH2)
          "22-3": [109,124],  // RU20: R87 (CH3)
          "22-1": [127,142],  // RU20: R85 (CH1)
          
          // RU18 (Groups 22, 23, 24, 26, 27, 28)
          "24-3": [1,16],     // RU18: R95 (CH3)
          "23-4": [19,34],    // RU18: R92 (CH4)
          "28-4": [37,52],    // RU18: R112 (CH4)
          "23-3": [55,70],    // RU18: R91 (CH3)
          "27-2": [73,88],    // RU18: R106 (CH2)
          "22-2": [91,106],   // RU18: R86 (CH2)
          "24-4": [109,124],  // RU18: R96 (CH4) - Note: was RU22, now RU18
          "26-2": [127,142],  // RU18: R102 (CH2)
          
          // RU16 (Group 28)
          "28-3": [1,16]      // RU16: R111 (CH3)
      };
      const t1CableMap = {17:1,18:1,19:2,20:2,21:3,22:3,23:4,24:4,25:5,26:5,27:6,28:6,29:7,30:7,31:8,32:8};
      const cable = t1CableMap[j];
      const planeType = (P % 2 === 0) ? 'even' : 'odd';
      
      // Determine the base rack (R_base) corresponding to the start of the 4-rack block
      const R_input_group_index = ((R - 1) % 4); 
      const R_base = R - R_input_group_index; 
      
      let isFullyMapped = true;
      let baseT2Jrp = 0; 
      for (let c = 1; c <= 4; c++) {
          const R_temp = R_base + (c - 1);
          
          // Skip racks outside the supported range or in gaps
          const isExplicitlyMapped = (R_temp >= 1 && R_temp <= 42) || (R_temp === 51) || 
                           (R_temp >= 61 && R_temp <= 70) || (R_temp >= 71 && R_temp <= 79) || 
                           (R_temp >= 80 && R_temp <= 85) || (R_temp >= 86 && R_temp <= 96) || (R_temp >= 99 && R_temp <= 100) || 
                           (R_temp === 101) || (R_temp === 102) || (R_temp === 106) || (R_temp === 107) || (R_temp === 111) || (R_temp === 112) || (R_temp === 114);
          if (!isExplicitlyMapped) {
              isFullyMapped = false;
              break; 
          }
          // --- Determine NDF Group and Key (Custom Logic - Must mirror compute()) ---
          let NDF_GROUP = 0;
          if (R_temp >= 1 && R_temp <= 24) { NDF_GROUP = Math.ceil(R_temp / 4); } 
          else if (R_temp >= 25 && R_temp <= 28) { NDF_GROUP = 7; } 
          else if (R_temp === 29) { NDF_GROUP = 8; } 
          else if (R_temp >= 30 && R_temp <= 32) { NDF_GROUP = 8; } 
          else if (R_temp >= 33 && R_temp <= 35) { NDF_GROUP = 9; }
          else if (R_temp === 36) { NDF_GROUP = 9; }
          else if (R_temp >= 37 && R_temp <= 40) { NDF_GROUP = 10; }
          else if (R_temp >= 41 && R_temp <= 42) { NDF_GROUP = 11; } 
          else if (R_temp === 51) { NDF_GROUP = 13; }
          else if (R_temp === 63) { NDF_GROUP = 16; }
          else if (R_temp === 62) { NDF_GROUP = 16; }
          else if (R_temp === 64) { NDF_GROUP = 16; }
          else if (R_temp === 65 || R_temp === 66 || R_temp === 67) { NDF_GROUP = 17; }
          else if (R_temp === 68) { NDF_GROUP = 17; }
          else if (R_temp === 69) { NDF_GROUP = 18; }
          else if (R_temp === 70) { NDF_GROUP = 18; }
          else if (R_temp === 74 || R_temp === 76) { NDF_GROUP = 19; }
          else if (R_temp === 79) { NDF_GROUP = 20; }
          else if (R_temp === 77) { NDF_GROUP = 20; }
          else if (R_temp === 75) { NDF_GROUP = 19; }
          else if (R_temp === 72) { NDF_GROUP = 18; }
          else if (R_temp === 73) { NDF_GROUP = 19; }
          else if (R_temp === 78) { NDF_GROUP = 20; }
          else if (R_temp === 71) { NDF_GROUP = 18; }
          else if (R_temp === 81 || R_temp === 82) { NDF_GROUP = 21; }
          else if (R_temp === 114) { NDF_GROUP = 29; }
          else if (R_temp === 98) { NDF_GROUP = 25; }
          else if (R_temp === 80) { NDF_GROUP = 20; }
          else if (R_temp === 83) { NDF_GROUP = 21; }
          else if (R_temp === 93) { NDF_GROUP = 24; }
          else if (R_temp === 97) { NDF_GROUP = 25; }
          else if (R_temp === 89) { NDF_GROUP = 23; }
          else if (R_temp === 88) { NDF_GROUP = 22; }
          else if (R_temp === 94) { NDF_GROUP = 24; }
          else if (R_temp === 99 || R_temp === 100) { NDF_GROUP = 25; }
          else if (R_temp === 107) { NDF_GROUP = 27; }
          else if (R_temp === 84) { NDF_GROUP = 21; }
          else if (R_temp === 85) { NDF_GROUP = 22; }
          else if (R_temp === 87) { NDF_GROUP = 22; }
          else if (R_temp === 90) { NDF_GROUP = 23; }
          else if (R_temp === 95) { NDF_GROUP = 24; }
          else if (R_temp === 92) { NDF_GROUP = 23; }
          else if (R_temp === 112) { NDF_GROUP = 28; }
          else if (R_temp === 91) { NDF_GROUP = 23; }
          else if (R_temp === 106) { NDF_GROUP = 27; }
          else if (R_temp === 86) { NDF_GROUP = 22; }
          else if (R_temp === 102) { NDF_GROUP = 26; }
          else if (R_temp === 101) { NDF_GROUP = 26; }
          else if (R_temp === 96) { NDF_GROUP = 24; }
          else if (R_temp === 111) { NDF_GROUP = 28; }
          
          if (NDF_GROUP === 0) { isFullyMapped = false; break; } // Safety check 
          
          const CH_T2_temp = ((R_temp - 1) % 4) + 1;
          const key = `${NDF_GROUP}-${CH_T2_temp}`;
          const pair = ndfRanges[key];
          
          // Determine RU based on rack number (Group 8 has mixed RU41/RU39)
          let NDF_RU = '—';
          if (NDF_GROUP >= 1 && NDF_GROUP <= 6) {
            const standardRU = { 1: 45, 2: 45, 3: 44, 4: 44, 5: 43, 6: 43 };
            NDF_RU = standardRU[NDF_GROUP] || '—';
          } else if (NDF_GROUP === 7) {
            NDF_RU = 41; // RU41 for R25-R28
          } else if (NDF_GROUP === 8) {
            // Group 8: Mixed - R29 is RU41, R30-R32 are RU39
            NDF_RU = (R_temp === 29) ? 41 : 39;
          } else if (NDF_GROUP === 9) {
            // Group 9: Mixed - R36 is RU37, R33-R35 are RU39
            NDF_RU = (R_temp === 36) ? 37 : 39;
          } else if (NDF_GROUP === 10) {
            NDF_RU = 37; // RU37 for R37-R40
          } else if (NDF_GROUP === 11) {
            NDF_RU = 41; // RU41 for R41-R42
          } else if (NDF_GROUP === 13) {
            NDF_RU = 39; // RU39 for R51
          } else if (NDF_GROUP >= 16 && NDF_GROUP <= 21) {
            // Groups 16-21: Mixed RU28, RU26, RU24, RU22, and RU20
            if (NDF_GROUP === 16) {
              if (R_temp === 63) {
                NDF_RU = 26; // R63=RU26
              } else if (R_temp === 62 || R_temp === 64) {
                NDF_RU = 28; // R62, R64=RU28
              }
            } else if (NDF_GROUP === 17) {
              NDF_RU = (R_temp >= 65 && R_temp <= 67) ? 26 : 28; // R65-R67=RU26, R68=RU28
            } else if (NDF_GROUP === 18) {
              if (R_temp === 69) {
                NDF_RU = 28; // R69=RU28
              } else if (R_temp === 70) {
                NDF_RU = 26; // R70=RU26
              } else if (R_temp === 71 || R_temp === 72) {
                NDF_RU = 24; // R71-R72=RU24
              }
            } else if (NDF_GROUP === 19) {
              if (R_temp === 74 || R_temp === 76) {
                NDF_RU = 26; // R74, R76=RU26
              } else if (R_temp === 75 || R_temp === 73) {
                NDF_RU = 24; // R75, R73=RU24
              }
            } else if (NDF_GROUP === 20) {
              if (R_temp === 79) {
                NDF_RU = 26; // R79=RU26
              } else if (R_temp === 77 || R_temp === 78) {
                NDF_RU = 24; // R77-R78=RU24
              } else if (R_temp === 80) {
                NDF_RU = 22; // R80=RU22
              }
            } else if (NDF_GROUP === 21) {
              if (R_temp === 81 || R_temp === 82) {
                NDF_RU = 24; // R81-R82=RU24
              } else if (R_temp === 83) {
                NDF_RU = 22; // R83=RU22
              } else if (R_temp === 84) {
                NDF_RU = 20; // R84=RU20
              }
            }
          } else if (NDF_GROUP >= 22 && NDF_GROUP <= 29) {
            // Groups 22-29: Mixed RU22, RU20, and RU18
            if (NDF_GROUP === 22) {
              if (R_temp === 88) {
                NDF_RU = 22; // R88=RU22
              } else if (R_temp === 85 || R_temp === 87) {
                NDF_RU = 20; // R85, R87=RU20
              } else if (R_temp === 86) {
                NDF_RU = 18; // R86=RU18
              }
            } else if (NDF_GROUP === 23) {
              if (R_temp === 89) {
                NDF_RU = 22; // R89=RU22
              } else if (R_temp === 90) {
                NDF_RU = 20; // R90=RU20
              } else if (R_temp === 91 || R_temp === 92) {
                NDF_RU = 18; // R91, R92=RU18
              }
            } else if (NDF_GROUP === 24) {
              if (R_temp === 93) {
                NDF_RU = 22; // R93=RU22
              } else if (R_temp === 94) {
                NDF_RU = 20; // R94=RU20
              } else if (R_temp === 95 || R_temp === 96) {
                NDF_RU = 18; // R95, R96=RU18
              }
            } else if (NDF_GROUP === 25) {
              if (R_temp === 97 || R_temp === 98) {
                NDF_RU = 22; // R97, R98=RU22
              } else if (R_temp === 99 || R_temp === 100) {
                NDF_RU = 20; // R99, R100=RU20
              }
            } else if (NDF_GROUP === 26) {
              if (R_temp === 101) {
                NDF_RU = 39; // R101=RU39
              } else if (R_temp === 102) {
                NDF_RU = 18; // R102=RU18
              }
            } else if (NDF_GROUP === 27) {
              if (R_temp === 107) {
                NDF_RU = 20; // R107=RU20
              } else if (R_temp === 106) {
                NDF_RU = 18; // R106=RU18
              }
            } else if (NDF_GROUP === 28) {
              if (R_temp === 111) {
                NDF_RU = 16; // R111=RU16
              } else if (R_temp === 112) {
                NDF_RU = 18; // R112=RU18
              }
            } else if (NDF_GROUP === 29) {
              NDF_RU = 22; // R114=RU22
            }
          }
          
          baseT2Jrp = Math.floor((R_temp - 1) / 4) + 1; // T2 JRP is constant for R_base to R_base+3
          if (!pair) {
              isFullyMapped = false;
              break;
          } 
          // --- Calculate MMC ---
          const [rangeStart] = pair;
          const half = 8;
          const base = (planeType === 'odd') ? rangeStart : rangeStart + half;
          const NDF_MMC = base + (cable - 1);
          // --- Format Output ---
          const item = document.createElement('div');
          const isCurrent = (R_temp === R);
          // Map channel to cable color (channel 1 = cable 1, channel 2 = cable 2, etc.)
          const cableNum = CH_T2_temp; // Channel 1-4 maps to Cable 1-4
          const cableClass = `cable${cableNum}`;
          
          // Apply cable color class and add current rack highlight
          let inlineStyle = '';
          if (isCurrent) {
            // Add extra emphasis for current rack
            inlineStyle = 'font-weight: 700; box-shadow: 0 0 0 2px rgba(245,158,11,0.5);';
          }
          
          // Format: jrp1-1 → Unit 45 MMC 9
          const styleAttr = inlineStyle ? ` style="${inlineStyle}"` : '';
          item.innerHTML = `<span class="${cableClass}"${styleAttr}>jrp${baseT2Jrp}-${CH_T2_temp} &rarr; Unit ${NDF_RU} MMC ${NDF_MMC}</span>`;
          summaryList.appendChild(item);
      }
      // --- Final Display Logic ---
      if (isFullyMapped && summaryList.children.length === 4) {
          if (ndfT2JrpNumEl) ndfT2JrpNumEl.textContent = baseT2Jrp;
          if (summaryWrapper) summaryWrapper.style.display = 'block';
          if (summaryList) summaryList.style.gridTemplateColumns = 'repeat(2, 1fr)';
      } else {
          if (summaryWrapper) summaryWrapper.style.display = 'none';
      }
    }
    
    // Subtle UI helper functions
    function showWithTransition(element) {
      if (!element) return;
      element.style.display = 'block';
      // Trigger CSS transition by forcing reflow
      void element.offsetWidth;
    }
    
    function scrollToElement(element, offset = 100) {
      if (!element) return;
      const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
      const offsetPosition = elementPosition - offset;
      window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
    }
    
    // Global storage for associated rack data (for click interactions)
    window._flowDiagramData = {};
    
    // Render data flow diagram with associated racks and cables (8 T2 RUs for JRP Pairs)
    function updateFlowDiagram(dev, P, R, j, channel, MMC, ndfRU, ndfMMC, JRP_T2, CH_T2, RU_T2) {
      const flowContainer = document.getElementById('flowDiagramContainer');
      if (!flowContainer) return;
      
      // Extract base name for T2 device construction
      const baseMatch = dev.match(/^(.+)-t1-/i);
      const baseName = baseMatch ? baseMatch[1] : dev.replace(/-t1-.*/i, '');
      
      // Determine base rack (R_base) for the 4-rack block
      const R_input_group_index = ((R - 1) % 4);
      const R_base = R - R_input_group_index;
      
      // Calculate associated JRP (pairs: 17-18, 19-20, 21-22, etc.)
      const jIsOdd = (j % 2 === 1);
      const associatedJRP = jIsOdd ? j + 1 : j - 1;
      const showJRPPair = (j >= 17 && j <= 32);
      
      // Determine the T1 JRPs in this pair (e.g., [17, 18])
      const JRP_PAIR_ARRAY = jIsOdd ? [j, associatedJRP] : [associatedJRP, j];
      
      // Initialize flow diagram data storage
      window._flowDiagramData = { ndfData: {} };
      
      // --- 1. Update NDF & Mini-Rack Labels ---
      const mmcLabel = document.getElementById('mmcLabel');
      const ndfLabel = document.getElementById('ndfLabel');
      const ndfCableLabel = document.getElementById('ndfCableLabel');
      
      if (mmcLabel) mmcLabel.textContent = `MMC ${MMC}`;
      if (ndfLabel) ndfLabel.textContent = ndfRU && ndfMMC ? `RU${ndfRU} · MMC ${ndfMMC}` : 'RU · MMC';
      
      const cableClass = (CH_T2 >= 1 && CH_T2 <= 4) ? `cable${CH_T2}` : '';
      ['mmcLabel', 'ndfLabel', 'ndfCableLabel'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
          if (cableClass) el.classList.add(cableClass);
          if (id === 'ndfCableLabel' && CH_T2 >= 1 && CH_T2 <= 4) {
            el.textContent = `cable${CH_T2}`;
          } else if (id === 'ndfCableLabel') {
            el.textContent = 'cable';
          }
        }
      });
      
      // Color coding for flow paths (only coloring the active T1 Rack's path)
      ['trunkPath', 'miniToNdfPath'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'inactive', 'active');
          if (cableClass) el.classList.add(cableClass, 'active');
          else el.classList.add('inactive');
        }
      });
      
      // --- 2. T1 Racks (Left Side - Remains 4 Blocks) ---
      const t1RackGroups = ['t1Rack1', 't1Rack2', 't1Rack3', 't1Rack4'];
      const t1RackLabels = ['t1R1Label', 't1R2Label', 't1R3Label', 't1R4Label'];
      const t1Arrows = ['t1Arrow1', 't1Arrow2', 't1Arrow3', 't1Arrow4'];
      
      for (let i = 0; i < 4; i++) {
        const R_temp = R_base + i;
        const CH_T2_temp = ((R_temp - 1) % 4) + 1;
        const labelEl = document.getElementById(t1RackLabels[i]);
        const jrpLabelEl = document.getElementById(`t1R${i+1}Jrp`);
        const rackGroup = document.getElementById(t1RackGroups[i]);
        const rackRect = rackGroup ? rackGroup.querySelector('rect') : null;
        const arrowEl = document.getElementById(t1Arrows[i]);
        
        // Setup T1 rack labels and colors
        if (rackRect) {
          const isCurrentT1 = (R_temp === R);
          rackRect.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'active', 'highlight', 'userRequested');
          if (CH_T2_temp >= 1 && CH_T2_temp <= 4) rackRect.classList.add(`cable${CH_T2_temp}`);
          if (isCurrentT1) {
            rackRect.classList.add('active', 'highlight', 'userRequested');
          }
          // Click handlers will be set by attachT1RackClickHandlers() at the end
          if (rackGroup) {
            rackGroup.style.cursor = 'pointer';
          }
        }
        
        // Update T1 to Mini-Rack arrows - only highlight the user-requested one
        if (arrowEl) {
          const isCurrentT1 = (R_temp === R);
          const arrowCableClass = (CH_T2_temp >= 1 && CH_T2_temp <= 4) ? `cable${CH_T2_temp}` : '';
          
          arrowEl.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'active', 'inactive');
          arrowEl.style.display = '';
          arrowEl.setAttribute('stroke-dasharray', '6 3');
          
          if (isCurrentT1) {
            // User-requested arrow: fully visible with cable color
            arrowEl.classList.add('active', arrowCableClass);
            arrowEl.style.opacity = '1';
            arrowEl.style.strokeWidth = '3.5';
            if (CH_T2_temp >= 1 && CH_T2_temp <= 4) {
              arrowEl.setAttribute('marker-end', `url(#arrowhead${CH_T2_temp})`);
            }
          } else {
            // Other arrows: very faded
            arrowEl.classList.add('inactive');
            arrowEl.style.opacity = '0.15';
            arrowEl.style.strokeWidth = '2';
            arrowEl.setAttribute('marker-end', 'url(#arrowhead)');
          }
        }
        
        // Store NDF data for each associated rack (Needed for click handler)
        window._flowDiagramData.ndfData[`rack${R_temp}`] = calculateNDFForRack(P, R_temp, j, CH_T2_temp);
        // Store rack metadata separately for reference
        window._flowDiagramData[`rack${R_temp}_meta`] = {
          dev, P, R: R_temp, j, channel, CH_T2: CH_T2_temp
        };
        
        // Update labels
        if (labelEl) labelEl.textContent = `P${P}-R${R_temp}`;
        if (jrpLabelEl) jrpLabelEl.textContent = showJRPPair ? `JRP ${JRP_PAIR_ARRAY.join(',')}` : `JRP ${j}`;
        
        // T1 to Mini-Rack arrows are already handled above in the setup section (lines 1532-1556)
        // No need to process them again here
      }
      
      // Add second arrow for JRP pair merging (if applicable)
      const existingMerge = document.getElementById('t1MergeArrow');
      if (existingMerge) existingMerge.remove();
      
      if (showJRPPair && R === R_base) {
        const mergeArrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        mergeArrow.id = 't1MergeArrow';
        mergeArrow.setAttribute('d', jIsOdd ? 'M 80 67 L 180 125' : 'M 80 67 L 180 115');
        mergeArrow.setAttribute('class', 'flowPath active');
        mergeArrow.setAttribute('marker-end', 'url(#arrowhead)');
        const t1ToMiniArrows = document.getElementById('t1ToMiniArrows');
        if (t1ToMiniArrows) t1ToMiniArrows.appendChild(mergeArrow);
      }
      
      // --- 3. T2 Channels (Right Side - Expanded to 8 Blocks) ---
      const T2_CHANNEL_IDS = ['t2Channel1', 't2Channel2', 't2Channel3', 't2Channel4', 't2Channel5', 't2Channel6', 't2Channel7', 't2Channel8'];
      const T2_LABEL_IDS = ['t2Ch1Label', 't2Ch2Label', 't2Ch3Label', 't2Ch4Label', 't2Ch5Label', 't2Ch6Label', 't2Ch7Label', 't2Ch8Label'];
      const T2_JRP_IDS = ['t2Ch1Jrp', 't2Ch2Jrp', 't2Ch3Jrp', 't2Ch4Jrp', 't2Ch5Jrp', 't2Ch6Jrp', 't2Ch7Jrp', 't2Ch8Jrp'];
      const NDF_TO_T2_PATHS = ['ndfToT2Path1', 'ndfToT2Path2', 'ndfToT2Path3', 'ndfToT2Path4', 'ndfToT2Path5', 'ndfToT2Path6', 'ndfToT2Path7', 'ndfToT2Path8'];
      
      let totalConnectionCount = 0;
      
      // Loop through the two T1 JRPs (e.g., 17, 18)
      JRP_PAIR_ARRAY.forEach(current_jrp => {
        // Loop through the four channels (1, 2, 3, 4) for EACH JRP
        for (let c = 1; c <= 4; c++) {
          if (totalConnectionCount >= T2_CHANNEL_IDS.length) break;
          
          const T2_RU_temp = 4 * (current_jrp - 17) + c; // R1-R8 for JRP 17/18
          const T2_JRP_temp = JRP_T2; // T2 JRP is constant for T1 Rack group
          const labelEl = document.getElementById(T2_LABEL_IDS[totalConnectionCount]);
          const jrpEl = document.getElementById(T2_JRP_IDS[totalConnectionCount]);
          const pathEl = document.getElementById(NDF_TO_T2_PATHS[totalConnectionCount]);
          const channelGroup = document.getElementById(T2_CHANNEL_IDS[totalConnectionCount]);
          const channelRect = channelGroup ? channelGroup.querySelector('rect') : null;
          
          // Highlight determination: Is this the specific JRP/Channel the user entered?
          const isCurrent = (current_jrp === j && c === channel);
          
          // Show channel (hide unused ones later)
          if (channelGroup) channelGroup.style.display = 'block';
          
          // Calculate T2 Channel for this connection (based on T1 rack group)
          // Note: T2 JRP is constant for the rack group, but T2 Channel varies by rack position
          const CH_T2_for_this = CH_T2; // All 8 connections share same T2 channel (based on input rack)
          
          // Calculate which T1 JRP-channel corresponds to this block (0-7)
          const jrp_idx = Math.floor(totalConnectionCount / 4); // 0 or 1
          const t1_channel = (totalConnectionCount % 4) + 1; // 1-4
          const t1_jrp = JRP_PAIR_ARRAY[jrp_idx];
          
          // Update T2 Channel Box - T2 info on left, T1 info on right
          // Left side: P#-T2-R# (top), JRP #-# (bottom)
          if (labelEl) {
            labelEl.textContent = `P${P}-T2-R${T2_RU_temp}`;
            labelEl.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8', 'highlight');
            const labelCable = totalConnectionCount + 1; // Sequential: 1-8
            if (labelCable >= 1 && labelCable <= 8) labelEl.classList.add(`cable${labelCable}`);
            if (isCurrent) labelEl.classList.add('highlight');
          }
          if (jrpEl) {
            jrpEl.textContent = `JRP ${T2_JRP_temp}-${CH_T2_for_this}`;
            jrpEl.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8', 'highlight');
            const jrpCable = totalConnectionCount + 1; // Sequential: 1-8
            if (jrpCable >= 1 && jrpCable <= 8) jrpEl.classList.add(`cable${jrpCable}`);
            if (isCurrent) jrpEl.classList.add('highlight');
          }
          
          // Right side: T1 JRP-channel (top-right corner)
          const t1InfoEl = document.getElementById(`t2Ch${totalConnectionCount + 1}T1Info`);
          if (t1InfoEl) {
            t1InfoEl.textContent = `T1:${t1_jrp}-${t1_channel}`;
          }
          
          // Color T2 Rect - use sequential cable color (1-8) and highlight if current
          if (channelRect) {
            const rectCable = totalConnectionCount + 1; // Sequential: 1-8
            channelRect.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8', 'highlight', 'active');
            if (rectCable >= 1 && rectCable <= 8) channelRect.classList.add(`cable${rectCable}`);
            if (isCurrent) {
              channelRect.classList.add('highlight', 'active');
            }
          }
          
          // Update NDF to T2 path (dotted line) - use sequential cable color (1-8)
          if (pathEl) {
            // Use sequential cable number (1-8) based on path index
            const pathCable = totalConnectionCount + 1; // 1-8
            const pathCableClass = (pathCable >= 1 && pathCable <= 8) ? `cable${pathCable}` : 'cable1';
            
            pathEl.classList.remove('inactive', 'cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8');
            pathEl.classList.add('active', pathCableClass);
            // Ensure dotted line style (like T1 to Mini-Rack)
            pathEl.setAttribute('stroke-dasharray', '6 3');
            // Ensure path is always visible
            pathEl.style.display = '';
            // All paths use their sequential cable colors - active one is brighter
            if (isCurrent) {
              pathEl.style.opacity = '1';
              // Use cable-based marker for current path
              if (pathCable >= 1 && pathCable <= 8) {
                pathEl.setAttribute('marker-end', `url(#arrowhead${pathCable})`);
              } else {
                pathEl.setAttribute('marker-end', 'url(#arrowhead)');
              }
            } else {
              // Other paths visible with their cable colors but slightly dimmed
              pathEl.style.opacity = '0.75';
              pathEl.setAttribute('marker-end', 'url(#arrowhead)');
            }
          }
          
          // Make box clickable (re-runs compute with the T1 JRP pair data)
          if (channelGroup) {
            channelGroup.style.cursor = 'pointer';
            channelGroup.onclick = () => {
              console.log(`T2 channel clicked -> idx ${totalConnectionCount + 1}, T2_RU ${T2_RU_temp}, j=${current_jrp}, c=${c}`);
              handleRackClick(dev, P, R, current_jrp, c);
            };
          }
          
          totalConnectionCount++;
        }
      });
      
      // Hide any unused blocks
      for (let i = totalConnectionCount; i < T2_CHANNEL_IDS.length; i++) {
        const channelGroup = document.getElementById(T2_CHANNEL_IDS[i]);
        if (channelGroup) channelGroup.style.display = 'none';
      }
      
      // Ensure ALL 8 paths are visible (even if not all channels are used)
      // All paths should be active, dotted, and visible
      NDF_TO_T2_PATHS.forEach((pathId) => {
        const path = document.getElementById(pathId);
        if (path) {
          path.classList.remove('inactive');
          path.classList.add('active');
          path.setAttribute('stroke-dasharray', '6 3');
          path.style.display = '';
          path.style.opacity = '1';
          // If not colored yet, set to brighter gray to ensure visibility
          if (!path.classList.contains('cable1') && !path.classList.contains('cable2') && 
              !path.classList.contains('cable3') && !path.classList.contains('cable4')) {
            path.setAttribute('stroke', '#9ca3af');
            path.style.opacity = '0.8';
          }
        }
      });
      
      // Highlight racks
      const racks = ['miniRackRect', 'ndfRect'];
      racks.forEach(id => {
        const rack = document.getElementById(id);
        if (rack) rack.classList.add('highlight');
      });
      
      // Ensure click handlers are properly attached after diagram is fully updated
      attachT1RackClickHandlers();
      
      // Show diagram
      flowContainer.style.display = 'block';
    }
    
    // Calculate NDF for a specific rack (reusable function)
    function calculateNDFForRack(P, R, j, CH_T2) {
      const isExplicitlyMapped = (R >= 1 && R <= 42) || (R === 51) || 
                           (R >= 61 && R <= 70) || (R >= 71 && R <= 79) || 
                           (R >= 80 && R <= 85) || (R >= 86 && R <= 96) || (R >= 99 && R <= 100) || 
                           (R === 101) || (R === 102) || (R === 106) || (R === 107) || (R === 111) || (R === 112) || (R === 114);
      const allowNDF = isExplicitlyMapped;
      if (!allowNDF) return { RU: '—', MMC: null, Range: [null, null], Cable: null, Group: 0 };
      
      let NDF_GROUP = 0;
      if (R >= 1 && R <= 24) {
        NDF_GROUP = Math.ceil(R / 4);
      } else if (R >= 25 && R <= 28) {
        NDF_GROUP = 7;
      } else if (R === 29) {
        NDF_GROUP = 8;
      } else if (R >= 30 && R <= 32) {
        NDF_GROUP = 8;
      } else if (R >= 33 && R <= 35) {
        NDF_GROUP = 9;
      } else if (R === 36) {
        NDF_GROUP = 9;
      } else if (R >= 37 && R <= 40) {
        NDF_GROUP = 10;
      } else if (R >= 41 && R <= 42) {
        NDF_GROUP = 11;
      } else if (R === 51) {
        NDF_GROUP = 13;
      } else if (R === 63) {
        NDF_GROUP = 16;
      } else if (R === 62) {
        NDF_GROUP = 16;
      } else if (R === 65) {
        NDF_GROUP = 17;
      } else if (R === 66) {
        NDF_GROUP = 17;
      } else if (R === 67) {
        NDF_GROUP = 17;
      } else if (R === 68) {
        NDF_GROUP = 17;
      } else if (R === 69) {
        NDF_GROUP = 18;
      } else if (R === 70) {
        NDF_GROUP = 18;
      } else if (R === 74) {
        NDF_GROUP = 19;
      } else if (R === 76) {
        NDF_GROUP = 19;
      } else if (R === 79) {
        NDF_GROUP = 20;
      } else if (R === 77) {
        NDF_GROUP = 20;
      } else if (R === 75) {
        NDF_GROUP = 19;
      } else if (R === 72) {
        NDF_GROUP = 18;
      } else if (R === 73) {
        NDF_GROUP = 19;
      } else if (R === 78) {
        NDF_GROUP = 20;
      } else if (R === 71) {
        NDF_GROUP = 18;
      } else if (R === 81 || R === 82) {
        NDF_GROUP = 21;
      } else if (R === 114) {
        NDF_GROUP = 29;
      } else if (R === 98) {
        NDF_GROUP = 25;
      } else if (R === 80) {
        NDF_GROUP = 20;
      } else if (R === 83) {
        NDF_GROUP = 21;
      } else if (R === 93) {
        NDF_GROUP = 24;
      } else if (R === 97) {
        NDF_GROUP = 25;
      } else if (R === 89) {
        NDF_GROUP = 23;
      } else if (R === 88) {
        NDF_GROUP = 22; // R88 - corrected from R96
      } else if (R === 94) {
        NDF_GROUP = 24;
      } else if (R === 99 || R === 100) {
        NDF_GROUP = 25;
      } else if (R === 107) {
        NDF_GROUP = 27;
      } else if (R === 84) {
        NDF_GROUP = 21;
      } else if (R === 85) {
        NDF_GROUP = 22;
      } else if (R === 87) {
        NDF_GROUP = 22;
      } else if (R === 90) {
        NDF_GROUP = 23;
      } else if (R === 95) {
        NDF_GROUP = 24;
      } else if (R === 92) {
        NDF_GROUP = 23;
      } else if (R === 112) {
        NDF_GROUP = 28;
      } else if (R === 91) {
        NDF_GROUP = 23;
      } else if (R === 106) {
        NDF_GROUP = 27;
      } else if (R === 86) {
        NDF_GROUP = 22;
      } else if (R === 102) {
        NDF_GROUP = 26;
      } else if (R === 101) {
        NDF_GROUP = 26; // R101 - RU39
      } else if (R === 96) {
        NDF_GROUP = 24; // R96 - Note: was RU22, now RU18
      } else if (R === 111) {
        NDF_GROUP = 28; // R111 - RU16
      }
      
      let NDF_RU = '—';
      if (NDF_GROUP >= 1 && NDF_GROUP <= 6) {
        const standardRU = { 1: 45, 2: 45, 3: 44, 4: 44, 5: 43, 6: 43 };
        NDF_RU = standardRU[NDF_GROUP] || '—';
      } else if (NDF_GROUP === 7 || NDF_GROUP === 11) {
        NDF_RU = 41;
      } else if (NDF_GROUP === 8) {
        NDF_RU = (R === 29) ? 41 : 39;
      } else if (NDF_GROUP === 9) {
        NDF_RU = (R === 36) ? 37 : 39;
      } else if (NDF_GROUP === 10) {
        NDF_RU = 37;
      } else if (NDF_GROUP === 13) {
        NDF_RU = 39;
      } else if (NDF_GROUP >= 16 && NDF_GROUP <= 21) {
        // Groups 16-21: Mixed RU28, RU26, RU24, RU22, and RU20
        if (NDF_GROUP === 16) {
          if (R === 63) {
            NDF_RU = 26; // R63=RU26
          } else if (R === 62 || R === 64) {
            NDF_RU = 28; // R62, R64=RU28
          }
        } else if (NDF_GROUP === 17) {
          NDF_RU = (R >= 65 && R <= 67) ? 26 : 28; // R65-R67=RU26, R68=RU28
        } else if (NDF_GROUP === 18) {
          if (R === 69) {
            NDF_RU = 28; // R69=RU28
          } else if (R === 70) {
            NDF_RU = 26; // R70=RU26
          } else if (R === 71 || R === 72) {
            NDF_RU = 24; // R71-R72=RU24
          }
        } else if (NDF_GROUP === 19) {
          if (R === 74 || R === 76) {
            NDF_RU = 26; // R74, R76=RU26
          } else if (R === 75 || R === 73) {
            NDF_RU = 24; // R75, R73=RU24
          }
        } else if (NDF_GROUP === 20) {
          if (R === 79) {
            NDF_RU = 26; // R79=RU26
          } else if (R === 77 || R === 78) {
            NDF_RU = 24; // R77-R78=RU24
          } else if (R === 80) {
            NDF_RU = 22; // R80=RU22
          }
        } else if (NDF_GROUP === 21) {
          if (R === 81 || R === 82) {
            NDF_RU = 24; // R81-R82=RU24
          } else if (R === 83) {
            NDF_RU = 22; // R83=RU22
          } else if (R === 84) {
            NDF_RU = 20; // R84=RU20
          }
        }
      } else if (NDF_GROUP >= 22 && NDF_GROUP <= 29) {
        // Groups 22-29: Mixed RU22, RU20, and RU18
        if (NDF_GROUP === 22) {
          if (R === 88) {
            NDF_RU = 22; // R88=RU22
          } else if (R === 85 || R === 87) {
            NDF_RU = 20; // R85, R87=RU20
          } else if (R === 86) {
            NDF_RU = 18; // R86=RU18
          }
        } else if (NDF_GROUP === 23) {
          if (R === 89) {
            NDF_RU = 22; // R89=RU22
          } else if (R === 90) {
            NDF_RU = 20; // R90=RU20
          } else if (R === 91 || R === 92) {
            NDF_RU = 18; // R91, R92=RU18
          }
        } else if (NDF_GROUP === 24) {
          if (R === 93) {
            NDF_RU = 22; // R93=RU22
          } else if (R === 94) {
            NDF_RU = 20; // R94=RU20
          } else if (R === 95 || R === 96) {
            NDF_RU = 18; // R95, R96=RU18
          }
        } else if (NDF_GROUP === 25) {
          if (R === 97 || R === 98) {
            NDF_RU = 22; // R97, R98=RU22
          } else if (R === 99 || R === 100) {
            NDF_RU = 20; // R99, R100=RU20
          }
        } else if (NDF_GROUP === 26) {
          NDF_RU = 18; // R102=RU18
        } else if (NDF_GROUP === 27) {
          if (R === 107) {
            NDF_RU = 20; // R107=RU20
          } else if (R === 106) {
            NDF_RU = 18; // R106=RU18
          }
        } else if (NDF_GROUP === 28) {
          if (R === 111) {
            NDF_RU = 16; // R111=RU16
          } else if (R === 112) {
            NDF_RU = 18; // R112=RU18
          }
        } else if (NDF_GROUP === 29) {
          NDF_RU = 22; // R114=RU22
        }
      }
      
      const ndfRanges = {
        "1-1": [1,16], "3-1": [1,16], "5-1": [1,16], "1-2": [19,34], "3-2": [19,34], "5-2": [19,34],
        "1-3": [37,52], "3-3": [37,52], "5-3": [37,52], "1-4": [55,70], "3-4": [55,70], "5-4": [55,70],
        "2-1": [73,88], "4-1": [73,88], "6-1": [73,88], "2-2": [91,106], "4-2": [91,106], "6-2": [91,106],
        "2-3": [109,124], "4-3": [109,124], "6-3": [109,124], "2-4": [127,142], "4-4": [127,142], "6-4": [127,142],
        "11-1": [1,16], "7-1": [37,52], "7-2": [55,70], "11-2": [73,88], "7-3": [91,106], "7-4": [109,124],
        "8-1": [127,142], "8-2": [19,34], "8-3": [37,52], "8-4": [55,70],
        "9-1": [73,88], "9-2": [91,106], "13-3": [109,124], "9-3": [127,142],
        "9-4": [1,16], "10-1": [19,34], "10-2": [55,70], "10-3": [73,88], "10-4": [91,106],
        "16-2": [109,124], "16-4": [127,142], "17-4": [73,88],
        "17-2": [1,16], "17-1": [19,34], "17-3": [37,52], "16-3": [55,70],
        "18-1": [91,106], "18-2": [73,88], "20-3": [91,106], "19-2": [109,124], "19-4": [127,142],
        "20-1": [1,16], "19-3": [19,34], "18-4": [37,52], "19-1": [55,70], 
        "20-2": [73,88], "18-3": [91,106], "21-1": [109,124], "21-2": [127,142],
        "29-2": [1,16], "25-2": [19,34], "20-4": [37,52], "21-3": [55,70], 
        "24-1": [73,88], "25-1": [91,106], "23-1": [109,124], "22-4": [127,142], // R88 - corrected from R96
        "24-2": [1,16], "25-3": [19,34], "25-4": [37,52], "27-3": [55,70], 
        "21-4": [73,88], "23-2": [91,106], "22-3": [109,124], "22-1": [127,142],
        "24-3": [1,16], "23-4": [19,34], "28-4": [37,52], "23-3": [55,70], 
        "27-2": [73,88], "22-2": [91,106], "24-4": [109,124], "26-2": [127,142],
        "28-3": [1,16],  // RU16: R111 (CH3)
        "26-1": [1,16]   // RU39: R101 (CH1)
      };
      
      const key = `${NDF_GROUP}-${CH_T2}`;
      const pair = ndfRanges[key];
      let NDF_MMC = null;
      let NDF_range = null;
      let cable = null;
      
      if (pair && NDF_GROUP > 0) {
        const [rangeStart, rangeEnd] = pair;
        const span = rangeEnd - rangeStart + 1;
        const half = span / 2;
        const planeType = (P % 2 === 0) ? 'even' : 'odd';
        const base = planeType === 'odd' ? rangeStart : rangeStart + half;
        const activeRange = [base, base + half - 1];
        NDF_range = activeRange;
        
        const t1CableMap = {17:1,18:1,19:2,20:2,21:3,22:3,23:4,24:4,25:5,26:5,27:6,28:6,29:7,30:7,31:8,32:8};
        cable = t1CableMap[j];
        if (cable) NDF_MMC = activeRange[0] + (cable - 1);
      }
      
      return { RU: NDF_RU, MMC: NDF_MMC, Range: NDF_range || [null, null], Cable: cable, Group: NDF_GROUP };
    }
    
    // Ensure T1 rack click handlers are always properly attached
    function attachT1RackClickHandlers() {
      const dev = document.getElementById('dev').value.trim();
      const jrpInput = document.getElementById('jrp').value.trim();
      const { j, channel } = parseJRPChannel(jrpInput);
      const { P, R } = parseFields(dev);
      
      // Calculate R_base from current input R
      const R_base = R - ((R - 1) % 4);
      
      const t1RackGroups = ['t1Rack1', 't1Rack2', 't1Rack3', 't1Rack4'];
      for (let i = 0; i < 4; i++) {
        const R_temp = R_base + i;
        const rackGroup = document.getElementById(t1RackGroups[i]);
        if (rackGroup) {
          // Remove any existing click handlers first
          rackGroup.onclick = null;
          rackGroup.style.cursor = 'pointer';
          // Use a closure with the correct R_temp value
          (function(rackNum) {
            rackGroup.onclick = () => {
              console.log(`T1 rack clicked -> R${rackNum} (base R${R_base}), j=${j}, channel=${channel}`);
              handleRackClick(dev, P, rackNum, j, channel);
            };
          })(R_temp);
        }
      }
    }
    
    // Handle click on T1 rack or T2 channel
    function handleRackClick(dev, P, R_clicked, j_clicked, channel_clicked) {
      console.log(`handleRackClick called: R_clicked=${R_clicked}, j=${j_clicked}, channel=${channel_clicked}`);
      // Calculate T2 details for clicked rack
      const CH_T2_clicked = ((R_clicked - 1) % 4) + 1;
      const JRP_T2_clicked = Math.floor((R_clicked - 1) / 4) + 1;
      
      // Recalculate NDF with correct j_clicked and channel_clicked for clicked rack
      const calculated = calculateNDFForRack(P, R_clicked, j_clicked, CH_T2_clicked);
      
      // ALWAYS update highlights and colors - these are visual feedback, not dependent on NDF validity
      updateFlowDiagramHighlights(R_clicked);
      updateFlowDiagramColors(R_clicked, CH_T2_clicked, j_clicked, channel_clicked);
      
      // ALWAYS update NDF display - show "Not defined yet" if MMC is null
      updateNDFDisplay(calculated, R_clicked, CH_T2_clicked, j_clicked);
      
      // Only update T2 channel labels if we have valid NDF data
      if (calculated.MMC !== null) {
        // Update T2 channel labels to reflect clicked rack's channel
        updateT2ChannelLabels(P, R_clicked, JRP_T2_clicked, CH_T2_clicked, j_clicked, channel_clicked);
      } else {
        console.log(`  ⚠ calculateNDFForRack returned MMC=null for R${R_clicked}, NDF mapping not defined`);
      }
      
      // Reattach click handlers after all updates
      attachT1RackClickHandlers();
    }
    
    // Update T2 channel labels when a different T1 rack is clicked
    function updateT2ChannelLabels(P, R_clicked, JRP_T2_clicked, CH_T2_clicked, j_clicked, channel_clicked) {
      const T2_CHANNEL_IDS = ['t2Channel1', 't2Channel2', 't2Channel3', 't2Channel4', 't2Channel5', 't2Channel6', 't2Channel7', 't2Channel8'];
      const T2_LABEL_IDS = ['t2Ch1Label', 't2Ch2Label', 't2Ch3Label', 't2Ch4Label', 't2Ch5Label', 't2Ch6Label', 't2Ch7Label', 't2Ch8Label'];
      const T2_JRP_IDS = ['t2Ch1Jrp', 't2Ch2Jrp', 't2Ch3Jrp', 't2Ch4Jrp', 't2Ch5Jrp', 't2Ch6Jrp', 't2Ch7Jrp', 't2Ch8Jrp'];
      
      // Determine JRP pair
      const jIsOddClick = (j_clicked % 2 === 1);
      const associatedJRP = jIsOddClick ? j_clicked + 1 : j_clicked - 1;
      const JRP_PAIR_ARRAY_CLICK = jIsOddClick ? [j_clicked, associatedJRP] : [associatedJRP, j_clicked];
      
      // Extract base name
      const devMatch = document.getElementById('dev').value.trim();
      const baseMatch = devMatch.match(/^(.+)-t1-/i);
      const baseName = baseMatch ? baseMatch[1] : devMatch.replace(/-t1-.*/i, '');
      
      let totalConnectionCount = 0;
      
      // Loop through JRP pairs and channels to update labels
      JRP_PAIR_ARRAY_CLICK.forEach(current_jrp => {
        for (let c = 1; c <= 4; c++) {
          if (totalConnectionCount >= T2_CHANNEL_IDS.length) break;
          
          const T2_RU_temp = 4 * (current_jrp - 17) + c;
          const labelEl = document.getElementById(T2_LABEL_IDS[totalConnectionCount]);
          const jrpEl = document.getElementById(T2_JRP_IDS[totalConnectionCount]);
          const channelGroup = document.getElementById(T2_CHANNEL_IDS[totalConnectionCount]);
          const channelRect = channelGroup ? channelGroup.querySelector('rect') : null;
          
          // Calculate which T1 JRP-channel corresponds to this block (0-7)
          const jrp_idx = Math.floor(totalConnectionCount / 4); // 0 or 1
          const t1_channel = (totalConnectionCount % 4) + 1; // 1-4
          const t1_jrp = JRP_PAIR_ARRAY_CLICK[jrp_idx];
          
          // Update T2 Channel Box - T2 info on left, T1 info on right
          // Left side: P#-T2-R# (top), JRP #-# (bottom)
          if (labelEl) {
            labelEl.textContent = `P${P}-T2-R${T2_RU_temp}`;
            labelEl.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8', 'highlight');
            const labelCableClick = totalConnectionCount + 1; // Sequential: 1-8
            if (labelCableClick >= 1 && labelCableClick <= 8) {
              labelEl.classList.add(`cable${labelCableClick}`);
            }
            const isCurrent = (current_jrp === j_clicked && c === channel_clicked);
            if (isCurrent) labelEl.classList.add('highlight');
          }
          if (jrpEl) {
            jrpEl.textContent = `JRP ${JRP_T2_clicked}-${CH_T2_clicked}`;
            jrpEl.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8', 'highlight');
            const jrpCableClick = totalConnectionCount + 1; // Sequential: 1-8
            if (jrpCableClick >= 1 && jrpCableClick <= 8) {
              jrpEl.classList.add(`cable${jrpCableClick}`);
            }
            const isCurrent = (current_jrp === j_clicked && c === channel_clicked);
            if (isCurrent) jrpEl.classList.add('highlight');
          }
          
          // Right side: T1 JRP-channel (top-right corner)
          const t1InfoEl = document.getElementById(`t2Ch${totalConnectionCount + 1}T1Info`);
          if (t1InfoEl) {
            t1InfoEl.textContent = `T1:${t1_jrp}-${t1_channel}`;
          }
          
          // Update T2 Rect color - use sequential cable color (1-8) and highlight if current
          if (channelRect) {
            const rectCableClick = totalConnectionCount + 1; // Sequential: 1-8
            channelRect.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8', 'highlight', 'active');
            if (rectCableClick >= 1 && rectCableClick <= 8) {
              channelRect.classList.add(`cable${rectCableClick}`);
            }
            const isCurrent = (current_jrp === j_clicked && c === channel_clicked);
            if (isCurrent) {
              channelRect.classList.add('highlight', 'active');
            }
          }
          
          totalConnectionCount++;
        }
      });
    }
    
    // Update NDF display with clicked rack's data
    function updateNDFDisplay(ndfData, R_clicked, CH_T2_clicked, j) {
      const ndfRU = document.getElementById('ndfRU');
      const ndfMMC = document.getElementById('ndfMMC');
      const ndfCable = document.getElementById('ndfCable');
      const ndfRange = document.getElementById('ndfRange');
      const ndfNote = document.getElementById('ndfNote');
      const ndfLabel = document.getElementById('ndfLabel');
      const mmcLabel = document.getElementById('mmcLabel');
      
      // Check if NDF mapping is defined (MMC is not null)
      const isDefined = ndfData.MMC !== null && ndfData.MMC !== undefined;
      const NDF_GROUP = ndfData.Group || 0;
      const key = `${NDF_GROUP}-${CH_T2_clicked}`;
      
      if (ndfRU) {
        if (isDefined) {
          ndfRU.textContent = ndfData.RU || '—';
        } else {
          ndfRU.textContent = '—';
        }
      }
      
      if (ndfMMC) {
        if (isDefined) {
          ndfMMC.textContent = ndfData.MMC || '—';
          // Apply channel-based color
          ndfMMC.className = 'ndfVal';
          if (CH_T2_clicked >= 1 && CH_T2_clicked <= 4) {
            ndfMMC.classList.add(`cable${CH_T2_clicked}`);
          }
        } else {
          // Show "Not defined yet" message
          ndfMMC.textContent = 'Not defined yet';
          ndfMMC.className = 'ndfVal';
          ndfMMC.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
        }
      }
      
      if (ndfCable) {
        if (isDefined) {
          ndfCable.textContent = ndfData.Cable || '—';
        } else {
          ndfCable.textContent = '—';
        }
      }
      
      if (ndfRange) {
        if (isDefined && ndfData.Range && ndfData.Range[0]) {
          ndfRange.textContent = `${ndfData.Range[0]}–${ndfData.Range[1]}`;
        } else {
          ndfRange.textContent = '—';
        }
      }
      
      if (ndfNote) {
        if (isDefined) {
          ndfNote.textContent = `Derived from JRP ${j} (cable ${ndfData.Cable || '—'}) in JRP_T2 ${Math.floor((R_clicked - 1) / 4) + 1}-${CH_T2_clicked}.`;
        } else {
          ndfNote.textContent = `NDF mapping for key ${key} (R${R_clicked}, CH${CH_T2_clicked}) is not defined yet.`;
        }
      }
      
      // Update flow diagram labels with color
      if (ndfLabel) {
        if (isDefined && ndfData.RU && ndfData.MMC) {
          ndfLabel.textContent = `RU${ndfData.RU} · MMC ${ndfData.MMC}`;
        } else {
          ndfLabel.textContent = 'RU · MMC';
        }
        ndfLabel.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
        if (isDefined && CH_T2_clicked >= 1 && CH_T2_clicked <= 4) {
          ndfLabel.classList.add(`cable${CH_T2_clicked}`);
        }
      }
      
      // Update cable number label when clicked
      const ndfCableLabel = document.getElementById('ndfCableLabel');
      if (ndfCableLabel) {
        if (isDefined && CH_T2_clicked >= 1 && CH_T2_clicked <= 4) {
          ndfCableLabel.textContent = `cable${CH_T2_clicked}`;
          ndfCableLabel.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
          ndfCableLabel.classList.add(`cable${CH_T2_clicked}`);
        } else {
          ndfCableLabel.textContent = 'cable';
          ndfCableLabel.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
        }
      }
      
      // Update colors for paths based on clicked rack's channel  
      // Note: j and channel should be j_clicked and channel_clicked but we use them from the updateNDFDisplay context
      // Actually, this should be called from handleRackClick with correct parameters
    }
    
    // Update all flow diagram colors based on clicked rack
    function updateFlowDiagramColors(R_clicked, CH_T2_clicked, j_clicked, channel_clicked) {
      const R_base = R_clicked - ((R_clicked - 1) % 4);
      const rackIndex = R_clicked - R_base;
      const cableClass = (CH_T2_clicked >= 1 && CH_T2_clicked <= 4) ? `cable${CH_T2_clicked}` : '';
      
      if (!cableClass) return;
      
      // Determine JRP pair array
      const jIsOdd = (j_clicked % 2 === 1);
      const JRP_PAIR_ARRAY = jIsOdd ? [j_clicked, j_clicked + 1] : [j_clicked - 1, j_clicked];
      
      // Calculate which of the 8 T2 paths corresponds to clicked rack
      // Each JRP has 4 channels, so we need to find the index in the 8-channel array
      let t2PathIndex = -1;
      JRP_PAIR_ARRAY.forEach((jrp, pairIdx) => {
        if (jrp === j_clicked) {
          // This is the JRP we're looking for
          t2PathIndex = pairIdx * 4 + (channel_clicked - 1);
        }
      });
      
      // Update all T1 arrows - only highlight the user-requested one, fade others
      const t1Arrows = ['t1Arrow1', 't1Arrow2', 't1Arrow3', 't1Arrow4'];
      const t1RackGroups = ['t1Rack1', 't1Rack2', 't1Rack3', 't1Rack4'];
      
      t1Arrows.forEach((id, idx) => {
        const arrow = document.getElementById(id);
        if (arrow) {
          const R_temp = R_base + idx;
          const CH_T2_temp = ((R_temp - 1) % 4) + 1;
          const arrowCableClass = (CH_T2_temp >= 1 && CH_T2_temp <= 4) ? `cable${CH_T2_temp}` : '';
          
          // Remove all classes
          arrow.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'inactive', 'active');
          arrow.style.display = '';
          arrow.setAttribute('stroke-dasharray', '6 3');
          
          if (idx === rackIndex) {
            // User-requested arrow: fully visible with cable color
            arrow.classList.add('active', cableClass);
            arrow.style.opacity = '1';
            arrow.style.strokeWidth = '3.5';
            if (CH_T2_clicked >= 1 && CH_T2_clicked <= 4) {
              arrow.setAttribute('marker-end', `url(#arrowhead${CH_T2_clicked})`);
            }
          } else {
            // Other arrows: very faded
            arrow.classList.add('inactive');
            arrow.style.opacity = '0.15';
            arrow.style.strokeWidth = '2';
            arrow.setAttribute('marker-end', 'url(#arrowhead)');
          }
        }
      });
      
      // Update T1 rack blocks - add animation to requested one and ensure colors are correct
      t1RackGroups.forEach((groupId, idx) => {
        const rackGroup = document.getElementById(groupId);
        if (rackGroup) {
          const rackRect = rackGroup.querySelector('rect');
          if (rackRect) {
            const R_temp = R_base + idx;
            const CH_T2_temp = ((R_temp - 1) % 4) + 1;
            
            // Remove all highlight classes first
            rackRect.classList.remove('active', 'highlight', 'userRequested');
            
            if (idx === rackIndex) {
              // This is the clicked rack - add all highlight classes
              rackRect.classList.add('active', 'highlight', 'userRequested');
            }
            
            // Ensure cable color class is correct (should already be set, but ensure it's there)
            rackRect.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
            if (CH_T2_temp >= 1 && CH_T2_temp <= 4) {
              rackRect.classList.add(`cable${CH_T2_temp}`);
            }
          }
        }
      });
      
      // Color trunk cable and Mini-Rack to NDF path
      const trunkPath = document.getElementById('trunkPath');
      const miniToNdfPath = document.getElementById('miniToNdfPath');
      if (trunkPath) {
        trunkPath.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
        trunkPath.classList.add(cableClass);
      }
      if (miniToNdfPath) {
        miniToNdfPath.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
        miniToNdfPath.classList.add(cableClass);
      }
      
      // Color Mini-Rack MMC label
      const mmcLabel = document.getElementById('mmcLabel');
      if (mmcLabel) {
        mmcLabel.classList.remove('cable1', 'cable2', 'cable3', 'cable4');
        mmcLabel.classList.add(cableClass);
      }
      
      // Update all NDF to T2 paths - each path uses sequential cable color (1-8)
      const ndfToT2Paths = ['ndfToT2Path1', 'ndfToT2Path2', 'ndfToT2Path3', 'ndfToT2Path4', 'ndfToT2Path5', 'ndfToT2Path6', 'ndfToT2Path7', 'ndfToT2Path8'];
      
      // Determine which path corresponds to clicked rack
      const jIsOddClick = (j_clicked % 2 === 1);
      const JRP_PAIR_ARRAY_CLICK = jIsOddClick ? [j_clicked, j_clicked + 1] : [j_clicked - 1, j_clicked];
      
      let clickedPathIndex = -1;
      let pathIdx = 0;
      JRP_PAIR_ARRAY_CLICK.forEach(jrp => {
        for (let ch = 1; ch <= 4; ch++) {
          if (pathIdx >= ndfToT2Paths.length) break;
          if (jrp === j_clicked && ch === channel_clicked) {
            clickedPathIndex = pathIdx;
          }
          pathIdx++;
        }
      });
      
      // Apply sequential cable colors (1-8) to each path
      ndfToT2Paths.forEach((pathId, idx) => {
        const path = document.getElementById(pathId);
        if (path) {
          const pathCable = idx + 1; // Sequential: 1, 2, 3, 4, 5, 6, 7, 8
          const pathCableClass = `cable${pathCable}`;
          
          path.classList.remove('cable1', 'cable2', 'cable3', 'cable4', 'cable5', 'cable6', 'cable7', 'cable8', 'inactive');
          path.classList.add('active', pathCableClass);
          // Ensure dotted line style is maintained
          path.setAttribute('stroke-dasharray', '6 3');
          path.style.display = '';
          
          if (idx === clickedPathIndex) {
            // Current path - full brightness
            path.style.opacity = '1';
            path.setAttribute('marker-end', `url(#arrowhead${pathCable})`);
          } else {
            // Other paths - visible with cable color but dimmed
            path.style.opacity = '0.75';
            path.setAttribute('marker-end', 'url(#arrowhead)');
          }
        }
      });
    }
    
    // Update flow diagram highlights when rack is clicked
    function updateFlowDiagramHighlights(R_clicked) {
      console.log(`updateFlowDiagramHighlights called with R_clicked=${R_clicked}`);
      const R_base = R_clicked - ((R_clicked - 1) % 4);
      const CH_T2_clicked = ((R_clicked - 1) % 4) + 1;
      console.log(`  R_base=${R_base}, CH_T2_clicked=${CH_T2_clicked}`);
      
      // Update T1 rack highlights
      const t1RackGroups = ['t1Rack1', 't1Rack2', 't1Rack3', 't1Rack4'];
      for (let i = 0; i < 4; i++) {
        const R_temp = R_base + i;
        const rackGroup = document.getElementById(t1RackGroups[i]);
        const rackRect = rackGroup ? rackGroup.querySelector('rect') : null;
        
        if (rackRect) {
          // Remove all highlight classes
          rackRect.classList.remove('active', 'highlight', 'userRequested');
          
          if (R_temp === R_clicked) {
            // Add all highlight classes for the clicked rack
            rackRect.classList.add('active', 'highlight', 'userRequested');
            console.log(`  ✓ Highlighted R${R_temp} (box ${i+1})`);
          }
        }
      }
      
      // Update T2 channel highlights (all 8 channels, highlight based on matching R, j, channel)
      // Note: T2 highlights are now determined by JRP/Channel combination, not just R
      // This is handled in updateFlowDiagram, so we just ensure highlights are cleared properly
      const t2ChannelGroups = ['t2Channel1', 't2Channel2', 't2Channel3', 't2Channel4', 't2Channel5', 't2Channel6', 't2Channel7', 't2Channel8'];
      t2ChannelGroups.forEach(id => {
        const channelGroup = document.getElementById(id);
        if (channelGroup && channelGroup.style.display !== 'none') {
          const channelRect = channelGroup.querySelector('rect');
          if (channelRect) {
            channelRect.classList.remove('highlight');
          }
        }
      });
    }
    
    function renderMMCDiagram(ctx) {
      const { MMC, Spare1, Spare2, blockStart } = ctx;
      const wrap = document.getElementById('mmcDiagram');
      if (!wrap) return;
      wrap.innerHTML = '';
      for (let pos = 1; pos <= 18; pos++) {
        const num = blockStart + pos - 1;
        const div = document.createElement('div');
        div.className = 'slot';
        div.dataset.num = String(num);
        if (pos <= 16) div.classList.add('mmc'); else div.classList.add('spare');
        if (num === MMC) div.classList.add('active');
        if (num === Spare1 || num === Spare2) div.classList.add('spare');
        div.textContent = String(num);
        wrap.appendChild(div);
      }
    }
    
    function hideReversePanel() {
      const panel = document.getElementById('reversePanel');
      if (panel) panel.style.display = 'none';
    }
    
    document.getElementById('calc').addEventListener('click', () => {
      console.log('🖱️ Calculate button clicked!');
      hideReversePanel();
      compute();
    });
    document.getElementById('reset').addEventListener('click', () => {
      hideReversePanel();
      document.getElementById('dev').value = '';
      document.getElementById('jrp').value = '';
      document.getElementById('out').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('outT2').style.display = 'none';
      const ndfOut = document.getElementById('outNDF');
      if (ndfOut) ndfOut.style.display = 'none';
      const summaryWrapper = document.getElementById('ndfChannelSummary');
      if (summaryWrapper) summaryWrapper.style.display = 'none';
      const flowContainer = document.getElementById('flowDiagramContainer');
      if (flowContainer) {
        flowContainer.style.display = 'none';
        // Reset flow diagram animations
        ['t1Arrow1', 't1Arrow2', 't1Arrow3', 't1Arrow4', 'miniToNdfPath', 'ndfToT2Path1', 'ndfToT2Path2', 'ndfToT2Path3', 'ndfToT2Path4', 'ndfToT2Path5', 'ndfToT2Path6', 'ndfToT2Path7', 'ndfToT2Path8'].forEach(id => {
          const path = document.getElementById(id);
          if (path) {
            path.classList.remove('active', 'cable1', 'cable2', 'cable3', 'cable4');
            path.classList.add('inactive');
          }
        });
        // Remove dynamically created merge arrow
        const mergeArrow = document.getElementById('t1MergeArrow');
        if (mergeArrow) mergeArrow.remove();
        ['miniRackRect', 'ndfRect'].forEach(id => {
          const rack = document.getElementById(id);
          if (rack) rack.classList.remove('highlight');
        });
        // Reset T1 rack labels
        ['t1R1Label', 't1R2Label', 't1R3Label', 't1R4Label'].forEach(id => {
          const label = document.getElementById(id);
          if (label) label.textContent = 'P-R · JRP';
        });
        // Reset T1 JRP labels
        ['t1R1Jrp', 't1R2Jrp', 't1R3Jrp', 't1R4Jrp'].forEach(id => {
          const label = document.getElementById(id);
          if (label) label.textContent = '';
        });
        // Reset T2 channel labels (8 channels now)
        ['t2Ch1Label', 't2Ch2Label', 't2Ch3Label', 't2Ch4Label', 't2Ch5Label', 't2Ch6Label', 't2Ch7Label', 't2Ch8Label'].forEach(id => {
          const label = document.getElementById(id);
          if (label) label.textContent = 'P-R · JRP-CH';
        });
        // Reset T2 channel highlights and show all
        ['t2Channel1', 't2Channel2', 't2Channel3', 't2Channel4', 't2Channel5', 't2Channel6', 't2Channel7', 't2Channel8'].forEach(id => {
          const channel = document.getElementById(id);
          if (channel) {
            channel.style.display = 'block';
            const rect = channel.querySelector('rect');
            if (rect) {
              rect.classList.remove('highlight', 'cable1', 'cable2', 'cable3', 'cable4');
            }
          }
        });
      }
      setFieldError('errDev','');
      setFieldError('errJrp','');
      liveValidate();
    });
    document.getElementById('copy').addEventListener('click', async () => {
      hideReversePanel();
      const copyBtn = document.getElementById('copy');
      const txt = window._copyText || 'Run a calculation first.';
      try { 
        await navigator.clipboard.writeText(txt);
        copyBtn.classList.add('copy-success');
        copyBtn.textContent = '✓ Copied!';
        setTimeout(() => {
          copyBtn.classList.remove('copy-success');
          copyBtn.textContent = 'Copy Result';
        }, 2000);
      }
      catch (e) { alert('Copy failed. ' + e); }
    });
    
    document.getElementById('toggleReverse').addEventListener('click', () => {
      const panel = document.getElementById('reversePanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    });
    
    // Auto example: prefill inputs without computing
    document.getElementById('autoExample').addEventListener('click', () => {
      hideReversePanel();
      document.getElementById('dev').value = 'sbn100-104-es-m1-p3-t1-r7';
      document.getElementById('jrp').value = '20-1';
      compute();
    });
    
    function reverseMMC() {
      const mmc = Number(document.getElementById('mmcInput').value);
      const err = document.getElementById('errorMMC');
      const out = document.getElementById('outMMC');
    
      if (Number.isNaN(mmc) || mmc < 1 || mmc > 144) {
        err.textContent = "Please enter a valid MMC number between 1 and 144.";
        err.style.display = 'block';
        out.style.display = 'none';
        return;
      } else {
        err.style.display = 'none';
      }
    
      const k = Math.floor((mmc - 1) / 18);
      const block_start = 18 * k + 1;
      const pos = mmc - block_start + 1;
      let P = null, ports = [], spare = false;
    
      if (pos >= 1 && pos <= 8) {
        P = 2 * k + 1;
        const i = pos - 1;
        ports = [17 + 2 * i, 18 + 2 * i];
      } else if (pos >= 9 && pos <= 16) {
        P = 2 * k + 2;
        const i = pos - 9;
        ports = [17 + 2 * i, 18 + 2 * i];
      } else {
        spare = true;
      }
    
      document.getElementById('rMMC').textContent = mmc;
      // Clear previous highlights, then emphasize
      document.querySelectorAll('#outMMC .kv').forEach(el => el.classList.remove('highlight-primary','highlight-secondary'));
      document.getElementById('rMMC').parentElement.classList.add('highlight-primary');
      document.getElementById('rSwitch').parentElement.classList.add('highlight-secondary');
      document.getElementById('rPorts').parentElement.classList.add('highlight-secondary');
      if (spare) {
        document.getElementById('rSwitch').textContent = "—";
        document.getElementById('rPorts').textContent = "—";
      } else {
        document.getElementById('rSwitch').textContent = "P" + P;
        document.getElementById('rPorts').textContent = ports[0] + " & " + ports[1];
      }
    
      document.getElementById('rMore').textContent =
        `Block start = ${block_start}, pos = ${pos}, k = ${k}`;
      out.style.display = 'block';
    }
    
    document.getElementById('findMMC').addEventListener('click', reverseMMC);
    document.getElementById('resetMMC').addEventListener('click', () => {
      document.getElementById('mmcInput').value = '';
      document.getElementById('errorMMC').style.display = 'none';
      document.getElementById('outMMC').style.display = 'none';
    });
    
    // Enter-to-submit: forward and reverse inputs
    ['dev','jrp'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          hideReversePanel();
          compute();
        }
      });
      el.addEventListener('input', () => {
        liveValidate();
      });
    });
    document.getElementById('mmcInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        reverseMMC();
      }
    });
    
    // Persist highlight on the last clicked button until another is clicked.
    const allButtons = Array.from(document.querySelectorAll('button'));
    allButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        allButtons.forEach(b => b.classList.remove('activeBtn'));
        btn.classList.add('activeBtn');
      });
    });
    
    // Click-to-map from MMC mini-diagram
    (function attachMMCDiagramClick(){
      const wrap = document.getElementById('mmcDiagram');
      if (!wrap) return;
      wrap.addEventListener('click', (e) => {
        const slot = e.target.closest('.slot');
        if (!slot) return;
        const mmc = Number(slot.dataset.num);
        if (Number.isNaN(mmc)) return;
        // Determine block, position and P/j from clicked MMC
        const k = Math.floor((mmc - 1) / 18);
        const block_start = 18 * k + 1;
        const pos = mmc - block_start + 1;
        let P = null, i = null;
        if (pos >= 1 && pos <= 8) { P = 2 * k + 1; i = pos - 1; }
        else if (pos >= 9 && pos <= 16) { P = 2 * k + 2; i = pos - 9; }
        else { return; } // ignore spares
    
        const currentJ = Number(document.getElementById('jrp').value);
        const base = 17 + 2 * i; // pair base
        const newJ = !Number.isNaN(currentJ) ? (currentJ % 2 === 0 ? base + 1 : base) : base;
    
        // Update dev's -p#- while keeping rest
        const devInput = document.getElementById('dev');
        let dev = devInput.value.trim();
        if (/-p\d+-/i.test(dev)) {
          dev = dev.replace(/-p(\d+)-/i, `-p${P}-`);
        }
        devInput.value = dev;
        document.getElementById('jrp').value = String(newJ);
        hideReversePanel();
        compute();
      });
    })();
    
    // Copy T2 details
    document.getElementById('copyT2').addEventListener('click', async () => {
      const copyBtn = document.getElementById('copyT2');
      const originalText = copyBtn.textContent;
      const ru = document.getElementById('t2RU').textContent;
      const jrp = document.getElementById('t2JRP').textContent;
      const ch = document.getElementById('t2CH').textContent;
      const plane = document.getElementById('t2Plane').textContent;
      const title = document.getElementById('t2Title').textContent;
      const txt = `${title}: RU ${ru}, JRP ${jrp}, CH ${ch}, Plane ${plane}`;
      try { 
        await navigator.clipboard.writeText(txt);
        copyBtn.classList.add('copy-success');
        copyBtn.textContent = '✓ Copied!';
        setTimeout(() => {
          copyBtn.classList.remove('copy-success');
          copyBtn.textContent = originalText;
        }, 2000);
      }
      catch (e) { alert('Copy failed. ' + e); }
    });
    
    // Copy NDF details
    document.getElementById('copyNDF').addEventListener('click', async () => {
      const copyBtn = document.getElementById('copyNDF');
      const originalText = copyBtn.textContent;
      const title = document.getElementById('ndfTitle').textContent;
      const ru = document.getElementById('ndfRU').textContent;
      const mmc = document.getElementById('ndfMMC').textContent;
      const cable = document.getElementById('ndfCable').textContent;
      const range = document.getElementById('ndfRange').textContent;
      const txt = `${title}: RU ${ru}, MMC ${mmc}, Cable ${cable}, Range ${range}`;
      try { 
        await navigator.clipboard.writeText(txt);
        copyBtn.classList.add('copy-success');
        copyBtn.textContent = '✓ Copied!';
        setTimeout(() => {
          copyBtn.classList.remove('copy-success');
          copyBtn.textContent = originalText;
        }, 2000);
      }
      catch (e) { alert('Copy failed. ' + e); }
    });
    
    // Permalink: prefill on load
    (function prefillFromURL(){
      try {
        const params = new URLSearchParams(location.search);
        const dev = params.get('dev');
        const jrp = params.get('jrp');
        const channel = params.get('channel');
        if (dev) document.getElementById('dev').value = dev;
        if (jrp) {
          const channelVal = channel ? Number(channel) : 1;
          document.getElementById('jrp').value = `${jrp}-${channelVal}`;
        }
        if (dev && jrp) compute(); else { liveValidate(); renderHistory(); }
      } catch { /* ignore */ }
    })();
    
    // History utilities
    function readHistory() {
      try {
        const raw = localStorage.getItem('t1_mapper_history');
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function writeHistory(list) {
      try { localStorage.setItem('t1_mapper_history', JSON.stringify(list)); } catch {}
    }
    function addToHistory(entry) {
      const list = readHistory();
      const key = (e) => `${e.dev}|${e.j}|${e.channel}`;
      const filtered = list.filter(e => key(e) !== key(entry));
      filtered.unshift(entry);
      writeHistory(filtered.slice(0,5));
    }
    function renderHistory() {
      const list = readHistory();
      const wrap = document.getElementById('historyList');
      if (!wrap) return;
      if (!list.length) { wrap.innerHTML = '<div class="muted">No recent lookups yet.</div>'; return; }
      wrap.innerHTML = '';
      list.forEach((e) => {
        const item = document.createElement('div');
        item.className = 'histItem';
        const left = document.createElement('div');
        left.innerHTML = `<div class="main">${e.dev}</div><div class="meta">JRP ${e.j}-${e.channel} · MMC ${e.MMC} · T2 RU ${e.t2.RU}, JRP ${e.t2.JRP}, CH ${e.t2.CH}</div>`;
        const right = document.createElement('div');
        right.className = 'histActions';
        const runBtn = document.createElement('button');
        runBtn.className = 'secondary';
        runBtn.textContent = 'Re-run';
        runBtn.addEventListener('click', () => {
          document.getElementById('dev').value = e.dev;
          document.getElementById('jrp').value = `${e.j}-${e.channel || 1}`;
          compute();
        });
        right.appendChild(runBtn);
        item.appendChild(left);
        item.appendChild(right);
        wrap.appendChild(item);
      });
    }
    
    document.getElementById('clearHistory').addEventListener('click', () => {
      writeHistory([]);
      renderHistory();
    });
    
    // Tab switching for NDF/T2
    (function initTabs(){
      const tabNDF = document.getElementById('tabNDF');
      const tabT2 = document.getElementById('tabT2');
      const paneNDF = document.getElementById('ndfTab');
      const paneT2 = document.getElementById('t2Tab');
      
      function switchTab(target) {
        // Remove active class from all tabs and panes
        [tabNDF, tabT2].forEach(btn => btn.classList.remove('active'));
        [paneNDF, paneT2].forEach(pane => pane.classList.remove('active'));
        
        // Add active class to selected tab and pane
        if (target === 'ndf') {
          tabNDF.classList.add('active');
          paneNDF.classList.add('active');
        } else {
          tabT2.classList.add('active');
          paneT2.classList.add('active');
        }
      }
      
      if (tabNDF) tabNDF.addEventListener('click', () => switchTab('ndf'));
      if (tabT2) tabT2.addEventListener('click', () => switchTab('t2'));
    })();
    </script>
    </body>
    </html>{{/html}}
